---
import Layout from '~/layouts/PageLayout.astro';

// Busca dados iniciais para preencher a tabela
const req = await fetch('https://fbpaf6pavow34cldqyown6spfi0tqrkf.lambda-url.us-east-2.on.aws/');
const data = await req.text();
// console.log(data); // Opcional: Log para debug no terminal

const autoresUnicos = Array.from(
  new Map(
    JSON.parse(data)
      .Items.filter((item) => item.autor && item.id) 
      .map((item) => [item.autor, item])
  ).values()
);
---

<Layout>
  <div>
    <h1 class="text-2xl font-bold mb-6">Autores</h1>
    <table class="w-full border-collapse border border-gray-300 mb-12">
      <thead>
        <tr class="border-b-2 border-gray-300">
          <th class="p-2.5 text-left">ID</th>
          <th class="p-2.5 text-left">Autor</th>
          <th class="p-2.5 text-left">Sort</th>
          <th class="p-2.5 text-left">Data de Inclusão</th>
        </tr>
      </thead>
      <tbody>
        {autoresUnicos.map((item) => (
          <tr class="border-b border-gray-200">
            <td class="p-2.5">{item.id}</td>
            <td class="p-2.5">{item.autor}</td>
            <td class="p-2.5">{item.sort}</td>
            <td class="p-2.5">{item['data-inclusao'] || '-'}</td>
          </tr>
        ))}
      </tbody>
    </table>

    <h2 class="text-xl font-bold mb-6">Adicionar Nova Frase</h2>
    
    <form id="form-frase" class="flex flex-col gap-4 max-w-md">
      <div>
        <label for="id" class="block mb-2">ID:</label>
        <input type="text" id="id" name="id" required class="w-full p-2 border border-gray-300 rounded" />
      </div>
      <div>
        <label for="sort" class="block mb-2">Sort (Frase):</label>
        <input type="text" id="sort" name="sort" required class="w-full p-2 border border-gray-300 rounded" />
      </div>
      <div>
        <label for="autor" class="block mb-2">Autor:</label>
        <input type="text" id="autor" name="autor" required class="w-full p-2 border border-gray-300 rounded" />
      </div>
      <button type="submit" class="p-2.5 bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600">
        Enviar
      </button>
    </form>
  </div>
</Layout>

<script>
  // Script roda no navegador do cliente
  const form = document.getElementById('form-frase');

  form.addEventListener('submit', async (e) => {
    e.preventDefault(); // Impede a página de recarregar

    // 1. Captura os dados dos inputs
    const formData = new FormData(form);
    
    // 2. Gera a data atual no formato YYYY-MM-DD
    const hoje = new Date().toISOString().split('T')[0];

    // 3. Monta o objeto JSON
    const payload = {
      id: formData.get('id'),
      sort: formData.get('sort'),
      autor: formData.get('autor'),
      "data-inclusao": hoje
    };

    try {
      // 4. Faz o POST para a nova URL
      const response = await fetch('https://nl47cekplgwzoaw4lh4zgcu6se0cozer.lambda-url.us-east-2.on.aws/frases', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        alert('Frase enviada com sucesso!');
        form.reset(); // Limpa o formulário
        window.location.reload(); // Recarrega a página para ver a atualização (opcional)
      } else {
        alert('Erro ao enviar: ' + response.statusText);
      }
    } catch (error) {
      console.error('Erro na requisição:', error);
      alert('Ocorreu um erro ao conectar com a API.');
    }
  });
</script>