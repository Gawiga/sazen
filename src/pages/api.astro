---
import Layout from '~/layouts/PageLayout.astro';

// 1. Busca dados iniciais
const req = await fetch('https://nl47cekplgwzoaw4lh4zgcu6se0cozer.lambda-url.us-east-2.on.aws/frases2');

// Mudei para .json() direto, pois é mais limpo que .text() + JSON.parse()
const rawData = await req.json(); 

// 2. Processamento dos dados (Ajustado para o novo formato de Array direto)
const autoresUnicos = Array.from(
  new Map(
    rawData // <--- AQUI MUDOU: Removemos o .Items
      .filter((item) => item.autor && item.id) // Remove itens sem autor ou id (como o id:1 do seu exemplo)
      .map((item) => [item.autor, item])
  ).values()
);
---

<Layout>
  <div>
    <h1 class="text-2xl font-bold mb-6">Autores</h1>
    
    <table class="w-full border-collapse border border-gray-300 mb-12">
      <thead>
        <tr class="border-b-2 border-gray-300 bg-gray-50">
          <th class="p-2.5 text-left">ID</th>
          <th class="p-2.5 text-left">Autor</th>
          <th class="p-2.5 text-left">Sort</th>
          <th class="p-2.5 text-left">Data de Inclusão</th>
        </tr>
      </thead>
      <tbody>
        {autoresUnicos.length > 0 ? (
          autoresUnicos.map((item) => (
            <tr class="border-b border-gray-200 hover:bg-gray-50">
              <td class="p-2.5">{item.id}</td>
              <td class="p-2.5 font-medium">{item.autor}</td>
              <td class="p-2.5">{item.sort}</td>
              <td class="p-2.5">{item['data-inclusao'] || '-'}</td>
            </tr>
          ))
        ) : (
          <tr>
            <td colspan="4" class="p-4 text-center text-gray-500">Nenhum autor encontrado.</td>
          </tr>
        )}
      </tbody>
    </table>

    <h2 class="text-xl font-bold mb-6">Adicionar Nova Frase</h2>
    
    <form id="form-frase" class="flex flex-col gap-4 max-w-md p-4 border border-gray-200 rounded shadow-sm">
      <div>
        <label for="id" class="block mb-2 font-medium">ID:</label>
        <input type="text" id="id" name="id" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: 123" />
      </div>
      <div>
        <label for="sort" class="block mb-2 font-medium">Sort (Frase):</label>
        <input type="text" id="sort" name="sort" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Penso, logo existo" />
      </div>
      <div>
        <label for="autor" class="block mb-2 font-medium">Autor:</label>
        <input type="text" id="autor" name="autor" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Descartes" />
      </div>
      <button type="submit" class="p-2.5 bg-blue-600 text-white font-bold rounded cursor-pointer hover:bg-blue-700 transition-colors">
        Enviar
      </button>
    </form>
  </div>
</Layout>

<script>
  const form = document.getElementById('form-frase');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); 

      // Botão de loading (UX opcional)
      const btn = form.querySelector('button');
      const originalText = btn.innerText;
      btn.innerText = 'Enviando...';
      btn.disabled = true;

      const formData = new FormData(form);
      const hoje = new Date().toISOString().split('T')[0];

      const payload = {
        id: formData.get('id'),
        sort: formData.get('sort'),
        autor: formData.get('autor'),
        "data-inclusao": hoje
      };

      try {
      // MUDANÇA AQUI: Agora chamamos a nossa própria API interna do Astro
      const response = await fetch('/enviar', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        alert('✅ Enviado com sucesso via Proxy!');
        (form as HTMLFormElement).reset();
        window.location.reload();
      } else {
        alert('❌ Erro no servidor.');
      }
    } catch (error) {
      alert('❌ Erro de conexão.');
    }

    //   try {
    //     // Atenção: Se der erro de CORS aqui, você precisará usar o Proxy do Astro (solução anterior)
    //     const response = await fetch('https://nl47cekplgwzoaw4lh4zgcu6se0cozer.lambda-url.us-east-2.on.aws/frases', {
    //       method: 'POST',
    //       headers: {
    //         'Content-Type': 'application/json'
    //       },
    //       body: JSON.stringify(payload)
    //     });

    //     if (response.ok) {
    //       alert('✅ Frase enviada com sucesso!');
    //       form.reset();
    //       // Recarrega para mostrar o novo item na tabela (se o backend atualizar rápido)
    //       window.location.reload(); 
    //     } else {
    //       alert('❌ Erro ao enviar: ' + response.statusText);
    //     }
    //   } catch (error) {
    //     console.error('Erro:', error);
    //     alert('❌ Erro de conexão ou CORS.');
    //   } finally {
    //     btn.innerText = originalText;
    //     btn.disabled = false;
    //   }
    });
  }
</script>