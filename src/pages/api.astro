---
import Layout from '~/layouts/PageLayout.astro';
---

<Layout>
  <style>
    /* Estilo para o efeito de "brilho" (fade-in dourado) */
    @keyframes highlight {
      0% {
        background-color: #fef3c7;
      }
      100% {
        background-color: transparent;
      }
    }
    .new-row-highlight {
      animation: highlight 3s ease-out;
    }
  </style>

  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6">Gerenciador de Autores</h1>

    <div class="mb-4">
      <label for="filtro-autor" class="block mb-2 font-medium text-gray-700">Filtrar por Autor:</label>
      <input
        type="text"
        id="filtro-autor"
        placeholder="Digite o nome do autor..."
        class="w-full p-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
      />
    </div>

    <table class="w-full border-collapse border border-gray-300 mb-12 shadow-sm rounded-lg overflow-hidden">
      <thead>
        <tr class="border-b-2 border-gray-300 bg-gray-50">
          <th class="p-2.5 text-left">ID</th>
          <th class="p-2.5 text-left">Autor</th>
          <th class="p-2.5 text-left">Sort</th>
          <th class="p-2.5 text-left">Data de Inclusão</th>
        </tr>
      </thead>
      <tbody id="tabela-autores">
        <tr>
          <td colspan="4" class="p-4 text-center text-gray-500 italic">Carregando autores...</td>
        </tr>
      </tbody>
    </table>

    <hr class="mb-12 border-gray-300" />

    <h2 class="text-xl font-bold mb-6">Adicionar Nova Frase</h2>

    <form id="form-frase" class="flex flex-col gap-4 max-w-md p-6 border border-gray-200 rounded-xl shadow-md bg-white">
      <div>
        <label for="id" class="block mb-1 font-medium">ID:</label>
        <input
          type="text"
          id="id"
          name="id"
          required
          class="w-full p-2 border border-gray-300 rounded outline-none focus:border-blue-500"
          placeholder="Ex: 123"
        />
      </div>
      <div>
        <label for="sort" class="block mb-1 font-medium">Sort (Frase):</label>
        <input
          type="text"
          id="sort"
          name="sort"
          required
          class="w-full p-2 border border-gray-300 rounded outline-none focus:border-blue-500"
          placeholder="Ex: Penso, logo existo"
        />
      </div>
      <div>
        <label for="autor" class="block mb-1 font-medium">Autor:</label>
        <input
          type="text"
          id="autor"
          name="autor"
          required
          class="w-full p-2 border border-gray-300 rounded outline-none focus:border-blue-500"
          placeholder="Ex: Descartes"
        />
      </div>
      <button
        type="submit"
        id="btn-enviar"
        class="p-3 bg-blue-600 text-white font-bold rounded-lg cursor-pointer hover:bg-blue-700 disabled:bg-gray-400 transition-all"
      >
        Enviar Frase
      </button>
    </form>
  </div>
</Layout>

<script>
  const form = document.getElementById('form-frase') as HTMLFormElement;
  const tabelaCorpo = document.getElementById('tabela-autores');
  const inputFiltro = document.getElementById('filtro-autor') as HTMLInputElement;

  let dadosOriginais: any[] = []; // Cache para o filtro funcionar sem nova requisição

  // --- GET: Buscar e Renderizar ---
  async function carregarAutores(highlightId = '') {
    try {
      // Chamamos a nossa function via GET
      const res = await fetch('/.netlify/functions/enviar');
      const rawData = await res.json();

      // Armazena no cache e remove duplicatas por autor
      dadosOriginais = Array.from(
        new Map(rawData.filter((item: any) => item.autor && item.id).map((item: any) => [item.autor, item])).values()
      );

      renderizarTabela(dadosOriginais, highlightId);
    } catch (error) {
      if (tabelaCorpo)
        tabelaCorpo.innerHTML =
          '<tr><td colspan="4" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
    }
  }

  function renderizarTabela(dados: any[], highlightId = '') {
    if (!tabelaCorpo) return;

    if (dados.length === 0) {
      tabelaCorpo.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Nenhum resultado encontrado.</td></tr>';
      return;
    }

    tabelaCorpo.innerHTML = dados
      .map((item) => {
        const isNew = String(item.id) === String(highlightId);
        return `
        <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors ${isNew ? 'new-row-highlight' : ''}">
          <td class="p-2.5 text-gray-600">${item.id}</td>
          <td class="p-2.5 font-semibold text-gray-800">${item.autor}</td>
          <td class="p-2.5 text-gray-700">${item.sort}</td>
          <td class="p-2.5 text-sm text-gray-500">${item['data-inclusao'] || '-'}</td>
        </tr>
      `;
      })
      .join('');
  }

  // --- Lógica do Filtro ---
  inputFiltro?.addEventListener('input', (e) => {
    const termo = (e.target as HTMLInputElement).value.toLowerCase();
    const filtrados = dadosOriginais.filter((item) => item.autor.toLowerCase().includes(termo));
    renderizarTabela(filtrados);
  });

  // --- POST: Enviar ---
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-enviar') as HTMLButtonElement;
    const originalText = btn.innerText;

    btn.innerText = 'Processando...';
    btn.disabled = true;

    const formData = new FormData(form);
    const currentId = formData.get('id') as string;
    const payload = {
      id: currentId,
      sort: formData.get('sort'),
      autor: formData.get('autor'),
      'data-inclusao': new Date().toISOString().split('T')[0],
    };

    try {
      const response = await fetch('/.netlify/functions/enviar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        form.reset();
        btn.innerText = '✅ Sucesso! Atualizando...';
        btn.style.backgroundColor = '#16a34a'; // Verde

        // Atraso de 2 segundos para o banco atualizar antes do refresh
        setTimeout(async () => {
          await carregarAutores(currentId);
          btn.innerText = originalText;
          btn.style.backgroundColor = '';
          btn.disabled = false;
          inputFiltro.value = ''; // Limpa o filtro para mostrar a nova linha
        }, 2000);
      } else {
        alert('Erro ao salvar frase.');
        btn.disabled = false;
        btn.innerText = originalText;
      }
    } catch (error) {
      alert('Erro de conexão.');
      btn.disabled = false;
      btn.innerText = originalText;
    }
  });

  // Carga inicial
  carregarAutores();
</script>
