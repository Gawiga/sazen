---
import PageLayout from "~/layouts/PageLayout.astro";

const metadata = {
  title: "Dashboard",
  description: "Seu painel de controle",
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto w-full max-w-5xl px-4 py-8 sm:py-10">
    <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-3xl font-bold">Dashboard</h1>
      <div id="user-menu-container"></div>
    </div>

    <nav class="mb-6 grid grid-cols-1 gap-3 sm:grid-cols-3">
      <a
        href="/pacientes"
        class="inline-flex min-h-12 items-center justify-center rounded-md border border-blue-700 bg-blue-600 px-4 py-3 text-base font-semibold text-white hover:bg-blue-700">
        Pacientes
      </a>
      <a
        href="/sessoes"
        class="inline-flex min-h-12 items-center justify-center rounded-md border border-green-700 bg-green-600 px-4 py-3 text-base font-semibold text-white hover:bg-green-700">
        Sessões
      </a>
      <a
        href="/relatorios"
        class="inline-flex min-h-12 items-center justify-center rounded-md border border-indigo-700 bg-indigo-600 px-4 py-3 text-base font-semibold text-white hover:bg-indigo-700">
        Relatórios
      </a>
    </nav>

    <div class="rounded-lg border bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
      <h2 class="mb-2 text-xl font-semibold">Bem-vindo ao seu dashboard</h2>
      <p class="text-sm text-slate-600 dark:text-slate-400">
        Gerencie pacientes, sessões e relatórios em um único lugar.
      </p>
    </div>
  </section>
</PageLayout>

<script is:inline>
  async function loadUserInfo() {
    try {
      const response = await fetch("/api/auth/user");
      const data = await response.json();

      let user = data.user?.record || data.user;
      if (!user?.name) {
        const pbAuth = localStorage.getItem("pb_auth");
        if (pbAuth) {
          const authData = JSON.parse(pbAuth);
          user = authData.model || authData.record;
        }
      }

      const container = document.getElementById("user-menu-container");
      if (!user || !container) {
        window.location.href = "/login";
        return;
      }

      container.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="hidden text-xs text-slate-500 sm:inline">${user.email || ""}</span>
          <span class="text-sm font-medium">Olá ${user.name || "Usuário"}</span>
<button
                id="logout-btn"
                class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition"
              >
                Sair
              </button>
        </div>
      `;

      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) logoutBtn.addEventListener("click", handleLogout);
    } catch (error) {
      console.error("Error loading user info:", error);
      window.location.href = "/login";
    }
  }

  async function handleLogout() {
    try {
      const response = await fetch("/api/auth/logout", { method: "POST" });
      if (response.ok) {
        localStorage.removeItem("pb_auth");
        window.location.href = "/";
      }
    } catch (error) {
      console.error("Logout error:", error);
    }
  }

  document.addEventListener("astro:page-load", loadUserInfo);
  if (document.readyState === "complete") loadUserInfo();
</script>
