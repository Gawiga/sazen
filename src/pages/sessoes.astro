---
import PageLayout from "~/layouts/PageLayout.astro";
import Loading from "~/components/widgets/Loading.astro";

const metadata = {
  title: "Sess√µes",
  description: "Cadastro e gerenciamento de sess√µes",
};

---

<PageLayout metadata={metadata}>
  <Loading />
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400">
      ‚Üê Voltar ao Dashboard
    </a>
    <div class="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">Sess√µes</h1>
      <button
        id="new-btn"
        class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
        >Nova sess√£o</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded border bg-white p-4 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-6">
      <form id="session-form" class="space-y-4">
        <input type="hidden" id="session-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Paciente</label
          >
          <select
            id="id_paciente"
            class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            required>
            <option value="">‚Äî selecione ‚Äî</option>
          </select>
        </div>
        <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_180px]">
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Data e Hora</label
            >
            <input
              id="data"
              type="datetime-local"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
              required
            />
          </div>
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Valor (R$)</label
            >
            <input
              id="valor"
              type="text"
              inputmode="decimal"
              placeholder="R$ 12,00"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            />
          </div>
        </div>
        <div>
          <label class="inline-flex cursor-pointer items-center">
            <input
              id="pago"
              type="checkbox"
              class="mr-2 h-4 w-4 rounded text-green-600"
            />
            <span class="text-sm text-gray-700 dark:text-gray-300">Pago</span>
          </label>
        </div>
        <div class="flex flex-col gap-2 pt-2 sm:flex-row sm:items-center">
          <button
            type="submit"
            class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="inline-flex min-h-11 items-center justify-center rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div class="mb-4 rounded bg-blue-50 p-3 text-sm text-blue-800 dark:bg-blue-900 dark:text-blue-200">
      <strong>üí° Dica:</strong> Clique em "Marcar como pago" (ou "Marcar pendente") para alternar o status da sess√£o. Use "Editar" para modificar dados da sess√£o ou "Excluir" para remov√™-la.
    </div>

    <div
      class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="sessions-count">0</span> sess√µes
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por p√°gina:</span>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="20">20</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="50">50</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr
            class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-3">Paciente</th>
            <th class="p-3">Data</th>
            <th class="p-3">Valor</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="sessions-body" class="align-top text-sm">
          <tr
            ><td colspan="5" class="p-4 text-center text-gray-500"
              >Carregando sess√µes...</td
            ></tr
          >
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400"
          >P√°gina 1 de 1</span
        >
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Pr√≥xima
        </button>
      </div>
    </div>
  </section>

  <script>
    import {
      getPaginationView,
      getPerPageValue,
    } from "~/services/paginationService";
    import { SessionService } from "~/services/sessionService";
    import { scrollToElement } from "~/services/uiService";
    import {
      formatCurrency,
      parseCurrency,
      formatDateForInput,
      formatDateInPortuguese,
      attachCurrencyMask,
      getFormElement,
      toggleElement,
    } from "~/utils/formatting";
    import type { Sessao, PacienteOption } from "~/types/api";

    const formContainerId = "form-container";

    let patientDetails = new Map<string, PacienteOption>();
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;

    const byId = (id: string) => getFormElement(id);

    async function loadSessions(page = 1) {
      const body = byId("sessions-body");
      try {
        const data = await SessionService.getSessions(page, perPage);

        currentPage = data.page;
        totalPages = data.totalPages;
        totalItems = data.totalItems;

        renderSessions(data.items);
        updatePaginationControls();
        updateSessionsCount();
      } catch (err) {
        console.error(err);
        if (body) {
          body.innerHTML =
            '<tr><td colspan="6" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
        }
      }
    }

    async function init() {
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      const form = byId("session-form") as HTMLFormElement;
      if (!form || form.dataset.initialized) return;
      form.dataset.initialized = "true";

      const valorInput = byId("valor") as HTMLInputElement;
      attachCurrencyMask(valorInput);

      try {
        await Promise.all([loadPatientsForSelect(), loadSessions()]);
      } catch (err) {
        console.error("Falha ao carregar dados iniciais:", err);
      }

      byId("id_paciente")?.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        const patientId = target.value;
        const sessionId = byId("session-id").value as string;

        if (!sessionId && patientId && patientDetails.has(patientId)) {
          const value = patientDetails.get(patientId)?.valor_sessao || 0;
          (valorInput).value = formatCurrency(value);
        }
      });

      byId("new-btn")?.addEventListener("click", () => {
        byId("session-id").value = "";
        form.reset();
        sortPatientsForSelect();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        byId("data").value = now.toISOString().slice(0, 16);
        toggleForm(true);
        scrollToElement(formContainerId);
      });

      byId("cancel-btn")?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", handleFormSubmit);
      attachPerPageListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updatePaginationControls();
    }

    async function handleFormSubmit(ev: Event) {
      ev.preventDefault();
      const id = byId("session-id").value as string;
      const rawDate = byId("data").value as string;
      const utcDate = rawDate ? new Date(rawDate).toISOString() : "";

      const payload: Partial<Sessao> = {
        id_paciente: byId("id_paciente").value as string,
        data: utcDate,
        valor: parseCurrency((byId("valor") as HTMLInputElement).value || ""),
        pago: (byId("pago") as HTMLInputElement).checked,
      };

      try {
        if (id) {
          await SessionService.updateSession(id, payload);
        } else {
          await SessionService.createSession(payload);
        }
        toggleForm(false);
        loadSessions(currentPage);
      } catch (err) {
        console.error(err);
        alert("Erro ao salvar sess√£o.");
      }
    }

    function toggleForm(show: boolean) {
      toggleElement(formContainerId, show);
    }

    async function loadPatientsForSelect() {
      try {
        const items = await SessionService.getAllPatients();
        patientDetails = new Map(items.map((p) => [p.id, p]));
        sortPatientsForSelect();
      } catch (err) {
        console.error("Erro ao carregar pacientes:", err);
      }
    }

    function sortPatientsByName(items: PacienteOption[]) {
      return items.sort((a, b) => {
        const nameA = (a.nome || a.email || "").toLowerCase();
        const nameB = (b.nome || b.email || "").toLowerCase();
        return nameA.localeCompare(nameB, "pt-BR");
      });
    }

    function sortPatientsForSelect() {
      const items = sortPatientsByName(Array.from(patientDetails.values()));
      const select = byId("id_paciente") as HTMLSelectElement;
      if (!select) return;

      const currentValue = select.value;
      select.innerHTML =
        '<option value="">‚Äî selecione ‚Äî</option>' +
        items
          .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
          .join("");
      select.value = currentValue;
    }

    function renderSessions(items: Sessao[]) {
      const body = byId("sessions-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhuma sess√£o registrada.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (session) => `
        <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
          <td class="p-2 dark:text-gray-300">
            <div class="font-medium">${
              patientDetails.get(session.id_paciente)?.nome ||
              "Paciente n√£o encontrado"
            }</div>
          </td>
          <td class="p-2 dark:text-gray-300">${formatDateInPortuguese(session.data)}</td>
          <td class="p-2 dark:text-gray-300">${formatCurrency(
            Number(session.valor) || 0
          )}</td>
          <td class="p-2">
            <span class="rounded px-2 py-1 text-xs ${
              session.pago
                ? "bg-green-100 text-green-800"
                : "bg-yellow-100 text-yellow-800"
            }">
              ${session.pago ? "Pago" : "Pendente"}
            </span>
          </td>
          <td class="p-2">
            <div class="flex items-center justify-end gap-2 whitespace-nowrap">
              <button data-id="${
                session.id
              }" title="${session.pago ? "Clique para marcar como pendente" : "Clique para marcar como pago"}" class="toggle-pago inline-flex min-h-10 items-center justify-center rounded ${
                session.pago ? "bg-yellow-400" : "bg-green-500"
              } px-3 py-2 text-sm text-white transition ${
                session.pago
                  ? "hover:bg-yellow-500"
                  : "hover:bg-green-600"
              }">
                ${session.pago ? "Marcar pendente" : "Marcar como pago"}
              </button>
              <button data-id="${session.id}" class="edit-btn inline-flex min-h-10 items-center justify-center rounded bg-yellow-400 px-3 py-2 text-sm text-gray-900 transition hover:bg-yellow-500">Editar</button>
              <button data-id="${session.id}" class="del-btn inline-flex min-h-10 items-center justify-center rounded bg-red-500 px-3 py-2 text-sm text-white transition hover:bg-red-600">Excluir</button>
            </div>
          </td>
        </tr>
      `,
        )
        .join("");

      attachRowListeners(items);
    }

    function attachRowListeners(items: Sessao[]) {
      // Toggle payment status
      document.querySelectorAll(".toggle-pago").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          
          // Find the session to get current status
          const session = items.find(s => s.id === id);
          if (!session) return;
          
          try {
            // Toggle the payment status
            await SessionService.togglePaymentStatus(id, session.pago);
            loadSessions(currentPage);
          } catch (err) {
            console.error(err);
            alert("Erro ao atualizar status de pagamento.");
          }
        });
      });

      // Edit session
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const session = items.find((s) => s.id === id);
          if (!session) return;

          byId("session-id").value = session.id || "";
          byId("id_paciente").value = session.id_paciente || "";
          byId("data").value = formatDateForInput(session.data);
          (byId("valor") as HTMLInputElement).value = formatCurrency(
            Number(session.valor) || 0
          );
          (byId("pago") as HTMLInputElement).checked = session.pago || false;

          toggleForm(true);
          scrollToElement(formContainerId);
        });
      });

      // Delete session
      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id || !confirm("Deseja realmente excluir esta sess√£o?")) return;

          try {
            await SessionService.deleteSession(id);
            loadSessions(currentPage);
          } catch (err) {
            console.error(err);
            alert("Erro ao excluir sess√£o.");
          }
        });
      });
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadSessions(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadSessions(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadSessions(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn");
      const nextBtn = byId("next-page-btn");
      const indicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) (prevBtn as HTMLButtonElement).disabled = !view.canPrev;
      if (nextBtn) (nextBtn as HTMLButtonElement).disabled = !view.canNext;
      if (indicator) indicator.textContent = view.indicator;
    }

    function updateSessionsCount() {
      const countEl = byId("sessions-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>