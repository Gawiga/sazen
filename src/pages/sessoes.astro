---
import PageLayout from "~/layouts/PageLayout.astro";
import Loading from "~/components/widgets/Loading.astro";

const metadata = {
  title: "Sessões",
  description: "Cadastro e gerenciamento de sessões",
};
---

<PageLayout metadata={metadata}>
  <Loading />
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400">
      ← Voltar ao Dashboard
    </a>
    <div
      class="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">
        Sessões
      </h1>
      <button
        id="new-btn"
        class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
        >Nova sessão</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded border bg-white p-4 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-6">
      <form id="session-form" class="space-y-4">
        <input type="hidden" id="session-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Paciente</label
          >
          <select
            id="id_paciente"
            class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            required>
            <option value="">— selecione —</option>
          </select>
        </div>
        <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_180px]">
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Data e Hora</label
            >
            <input
              id="data"
              type="datetime-local"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
              required
            />
          </div>
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Valor (R$)</label
            >
            <input
              id="valor"
              type="text"
              inputmode="decimal"
              placeholder="R$ 12,00"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            />
          </div>
        </div>
        <div>
          <label class="inline-flex cursor-pointer items-center">
            <input
              id="pago"
              type="checkbox"
              class="mr-2 h-4 w-4 rounded text-green-600"
            />
            <span class="text-sm text-gray-700 dark:text-gray-300">Pago</span>
          </label>
        </div>
        <div class="flex flex-col gap-2 pt-2 sm:flex-row sm:items-center">
          <button
            type="submit"
            class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="inline-flex min-h-11 items-center justify-center rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>


    <div
      class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div
        class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="sessions-count">0</span> sessões
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Paciente:</span>
          <input
            id="session-name-filter"
            type="text"
            placeholder="Filtrar por nome"
            class="w-40 rounded border bg-white px-2 py-1 text-sm dark:border-gray-700 dark:bg-gray-800 dark:text-white sm:w-56"
          />
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400"
            >Por página:</span
          >
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="20">20</button
          >
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="50">50</button
          >
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="100">100</button
          >
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr
            class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-3">Paciente</th>
            <th class="p-3 text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="sessions-body" class="align-top text-sm">
          <tr
            ><td colspan="2" class="p-4 text-center text-gray-500"
              >Carregando sessões...</td
            ></tr
          >
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span
          id="page-indicator"
          class="text-sm text-gray-600 dark:text-gray-400">Página 1 de 1</span
        >
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script>
    import {
      getPaginationView,
      getPerPageValue,
    } from "~/services/paginationService";
    import {SessionService} from "~/services/sessionService";
    import {scrollToElement} from "~/services/uiService";
    import {
      formatCurrency,
      parseCurrency,
      formatDateForInput,
      attachCurrencyMask,
      getFormElement,
      toggleElement,
    } from "~/utils/formatting";
    import type {Sessao, PacienteOption} from "~/types/api";

    const formContainerId = "form-container";

    let patientDetails = new Map<string, PacienteOption>();
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;
    let patientsLoaded = false;
    let sessionNameFilter = "";
    let loadedSessions: Sessao[] = [];

    const byId = (id: string) => getFormElement(id);

    async function loadSessions(page = 1) {
      const body = byId("sessions-body");
      if (!patientsLoaded) return;
      try {
        const data = await SessionService.getSessions(page, perPage);

        currentPage = data.page;
        totalPages = data.totalPages;
        totalItems = data.totalItems;
        loadedSessions = data.items;

        applySessionFilter();
        updatePaginationControls();
      } catch (err) {
        console.error(err);
        if (body) {
          body.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
        }
      }
    }

    async function init() {
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      const form = byId("session-form") as HTMLFormElement;
      if (!form || form.dataset.initialized) return;
      form.dataset.initialized = "true";

      const valorInput = byId("valor") as HTMLInputElement;
      attachCurrencyMask(valorInput);

      try {
        await loadPatientsForSelect();
        await loadSessions();
      } catch (err) {
        console.error("Falha ao carregar dados iniciais:", err);
        const body = byId("sessions-body");
        if (body) {
          body.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-red-500">Erro ao carregar pacientes para as sessões.</td></tr>';
        }
      }

      byId("id_paciente")?.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        const patientId = target.value;
        const sessionId = byId("session-id").value as string;

        if (!sessionId && patientId && patientDetails.has(patientId)) {
          const value = patientDetails.get(patientId)?.valor_sessao || 0;
          valorInput.value = formatCurrency(value);
        }
      });

      byId("new-btn")?.addEventListener("click", () => {
        byId("session-id").value = "";
        form.reset();
        sortPatientsForSelect();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        byId("data").value = now.toISOString().slice(0, 16);
        toggleForm(true);
        scrollToElement(formContainerId);
      });

      byId("cancel-btn")?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", handleFormSubmit);
      attachSessionFilterListener();
      attachPerPageListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updatePaginationControls();
      attachBannerListeners();
    }

    async function handleFormSubmit(ev: Event) {
      ev.preventDefault();
      const id = byId("session-id").value as string;
      const rawDate = byId("data").value as string;
      const utcDate = rawDate ? new Date(rawDate).toISOString() : "";

      const payload: Partial<Sessao> = {
        id_paciente: byId("id_paciente").value as string,
        data: utcDate,
        valor: parseCurrency((byId("valor") as HTMLInputElement).value || ""),
        pago: (byId("pago") as HTMLInputElement).checked,
      };

      try {
        if (id) {
          await SessionService.updateSession(id, payload);
        } else {
          await SessionService.createSession(payload);
        }
        toggleForm(false);
        loadSessions(currentPage);
      } catch (err) {
        console.error(err);
        alert("Erro ao salvar sessão.");
      }
    }

    function toggleForm(show: boolean) {
      toggleElement(formContainerId, show);
    }

    async function loadPatientsForSelect() {
      const items = await SessionService.getAllPatients();
      patientDetails = new Map(items.map((p) => [p.id, p]));
      patientsLoaded = true;
      sortPatientsForSelect();
    }

    function sortPatientsByName(items: PacienteOption[]) {
      return items.sort((a, b) => {
        const nameA = (a.nome || a.email || "").toLowerCase();
        const nameB = (b.nome || b.email || "").toLowerCase();
        return nameA.localeCompare(nameB, "pt-BR");
      });
    }

    function sortPatientsForSelect() {
      const items = sortPatientsByName(Array.from(patientDetails.values()));
      const select = byId("id_paciente") as HTMLSelectElement;
      if (!select) return;

      const currentValue = select.value;
      select.innerHTML =
        '<option value="">— selecione —</option>' +
        items
          .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
          .join("");
      select.value = currentValue;
    }

    function renderSessions(items: Sessao[]) {
      const body = byId("sessions-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="2" class="p-4 text-center text-gray-500">Nenhuma sessão registrada.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (session) => `
        <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
          <td class="p-2 dark:text-gray-300">
            <div class="font-semibold text-gray-900 dark:text-gray-100">${
              patientDetails.get(session.id_paciente)?.nome ||
              "Paciente não encontrado"
            }</div>
            <div class="text-xs text-gray-500">${formatSessionDateDetailed(session.data)}</div>
            <div class="text-xs text-gray-500">Valor Sessão: ${formatCurrency(
              Number(session.valor) || 0,
            )}</div>
            <div class="text-xs text-gray-500">Pagamento: ${session.pago ? "Pago" : "Pendente"}</div>
          </td>
          <td class="p-2 text-right">
            <details class="row-actions-menu relative inline-block text-left">
              <summary
                class="inline-flex min-h-10 min-w-10 cursor-pointer list-none items-center justify-center rounded border border-gray-300 bg-white px-2 py-2 text-gray-700 transition hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
                aria-label="Abrir ações da sessão"
                title="Abrir ações">
                <span class="sr-only">Abrir ações</span>
                <span class="inline-flex flex-col gap-1" aria-hidden="true">
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                </span>
              </summary>
              <div class="absolute right-0 z-10 mt-1 w-52 rounded border bg-white p-1 shadow-lg dark:border-gray-700 dark:bg-gray-800">
                <button
                  type="button"
                  data-id="${session.id}"
                  title="Clique para alternar o status entre Pago e Pendente"
                  class="status-toggle block w-full rounded px-3 py-2 text-left text-sm transition hover:bg-gray-100 dark:hover:bg-gray-700 ${
                    session.pago
                      ? "text-green-700 dark:text-green-400"
                      : "text-yellow-700 dark:text-yellow-400"
                  }">
                  ${session.pago ? "Marcar como pendente" : "Marcar como pago"}
                </button>
                <button data-id="${session.id}" class="edit-btn block w-full rounded px-3 py-2 text-left text-sm text-gray-800 transition hover:bg-yellow-100 dark:text-gray-200 dark:hover:bg-gray-700">Editar</button>
                <button data-id="${session.id}" class="del-btn block w-full rounded px-3 py-2 text-left text-sm text-red-600 transition hover:bg-red-50 dark:text-red-400 dark:hover:bg-gray-700">Excluir</button>
              </div>
            </details>
          </td>
        </tr>
      `,
        )
        .join("");

      attachRowListeners(items);
    }

    function applySessionFilter() {
      const query = sessionNameFilter.trim().toLowerCase();
      const filtered = !query
        ? loadedSessions
        : loadedSessions.filter((session) => {
            const patientName =
              patientDetails.get(session.id_paciente)?.nome ||
              patientDetails.get(session.id_paciente)?.email ||
              "";
            return patientName.toLowerCase().includes(query);
          });

      renderSessions(filtered);
      updateSessionsCount(filtered.length);
    }

    function attachRowListeners(items: Sessao[]) {
      // Toggle payment status through the label in the Status column
      document.querySelectorAll(".status-toggle").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;

          // Find the session to get current status
          const session = items.find((s) => s.id === id);
          if (!session) return;

          try {
            // Toggle the payment status
            await SessionService.togglePaymentStatus(id, session.pago);
            loadSessions(currentPage);
            (btn.closest("details") as HTMLDetailsElement | null)?.removeAttribute("open");
          } catch (err) {
            console.error(err);
            alert("Erro ao atualizar status de pagamento.");
          }
        });
      });

      // Edit session
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const session = items.find((s) => s.id === id);
          if (!session) return;

          byId("session-id").value = session.id || "";
          byId("id_paciente").value = session.id_paciente || "";
          byId("data").value = formatDateForInput(session.data);
          (byId("valor") as HTMLInputElement).value = formatCurrency(
            Number(session.valor) || 0,
          );
          (byId("pago") as HTMLInputElement).checked = session.pago || false;

          toggleForm(true);
          scrollToElement(formContainerId);
          (btn.closest("details") as HTMLDetailsElement | null)?.removeAttribute("open");
        });
      });

      // Delete session
      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id || !confirm("Deseja realmente excluir esta sessão?")) return;

          try {
            await SessionService.deleteSession(id);
            loadSessions(currentPage);
            (btn.closest("details") as HTMLDetailsElement | null)?.removeAttribute("open");
          } catch (err) {
            console.error(err);
            alert("Erro ao excluir sessão.");
          }
        });
      });
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (!patientsLoaded) return;
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadSessions(currentPage);
        });
      });
    }

    function attachSessionFilterListener() {
      const input = byId("session-name-filter") as HTMLInputElement | null;
      input?.addEventListener("input", () => {
        const previousQuery = sessionNameFilter.trim();
        sessionNameFilter = input.value;
        if (sessionNameFilter.trim() === "" && previousQuery !== "") {
          loadSessions(currentPage);
          return;
        }

        applySessionFilter();
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (!patientsLoaded) return;
        if (currentPage <= 1) return;
        loadSessions(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (!patientsLoaded) return;
        if (currentPage >= totalPages) return;
        loadSessions(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn");
      const nextBtn = byId("next-page-btn");
      const indicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) (prevBtn as HTMLButtonElement).disabled = !view.canPrev;
      if (nextBtn) (nextBtn as HTMLButtonElement).disabled = !view.canNext;
      if (indicator) indicator.textContent = view.indicator;
    }

    function updateSessionsCount(filteredCount = loadedSessions.length) {
      const countEl = byId("sessions-count");
      if (!countEl) return;

      if (sessionNameFilter.trim()) {
        countEl.textContent = `${filteredCount} de ${totalItems}`;
        return;
      }

      countEl.textContent = String(totalItems);
    }

    function formatSessionDateShort(dateString: string): string {
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return dateString;

      const month = new Intl.DateTimeFormat("pt-BR", {
        month: "short",
      })
        .format(date)
        .replace(".", "")
        .toLowerCase();

      const day = String(date.getDate()).padStart(2, "0");
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");

      return `${day}/${month} às ${hours}h${minutes}`;
    }

    function formatSessionDateDetailed(dateString: string): string {
      const date = new Date(dateString);
      if (Number.isNaN(date.getTime())) return dateString;

      const weekdays = [
        "Domingo",
        "Segunda",
        "Terça",
        "Quarta",
        "Quinta",
        "Sexta",
        "Sábado",
      ];

      return `${weekdays[date.getDay()]} - ${formatSessionDateShort(dateString)}`;
    }

    function attachBannerListeners() {
      byId("close-sessions-banner")?.addEventListener("click", () => {
        byId("sessions-info-banner")?.classList.add("hidden");
      });
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
