---
import PageLayout from "~/layouts/PageLayout.astro";

const metadata = {
  title: "Sessões",
  description: "Cadastro e gerenciamento de sessões",
};

---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400">
      ← Voltar ao Dashboard
    </a>
    <div class="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">Sessões</h1>
      <button
        id="new-btn"
        class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
        >Nova sessão</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded border bg-white p-4 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-6">
      <form id="session-form" class="space-y-4">
        <input type="hidden" id="session-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Paciente</label
          >
          <select
            id="id_paciente"
            class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            required>
            <option value="">— selecione —</option>
          </select>
        </div>
        <div class="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_180px]">
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Data e Hora</label
            >
            <input
              id="data"
              type="datetime-local"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
              required
            />
          </div>
          <div>
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Valor (R$)</label
            >
            <input
              id="valor"
              type="text"
              inputmode="decimal"
              placeholder="R$ 12,00"
              class="mt-1 w-full rounded border bg-white p-2 focus:ring-2 focus:ring-green-500 dark:bg-gray-800"
            />
          </div>
        </div>
        <div>
          <label class="inline-flex cursor-pointer items-center">
            <input
              id="pago"
              type="checkbox"
              class="mr-2 h-4 w-4 rounded text-green-600"
            />
            <span class="text-sm text-gray-700 dark:text-gray-300">Pago</span>
          </label>
        </div>
        <div class="flex flex-col gap-2 pt-2 sm:flex-row sm:items-center">
          <button
            type="submit"
            class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="inline-flex min-h-11 items-center justify-center rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div
      class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="sessions-count">0</span> sessões
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por página:</span>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="20">20</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="50">50</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr
            class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-3">Paciente</th>
            <th class="p-3">Data</th>
            <th class="p-3">Valor</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="sessions-body" class="align-top text-sm">
          <tr
            ><td colspan="5" class="p-4 text-center text-gray-500"
              >Carregando sessões...</td
            ></tr
          >
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400"
          >Página 1 de 1</span
        >
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script>
/* eslint-disable @typescript-eslint/no-explicit-any */

    import {
      buildPaginationParams,
      getPaginationView,
      getPerPageValue,
      normalizePaginationData,
    } from "~/services/paginationService";

    const collectionBase = "/api/sessoes";
    type PacienteOption = {
      id: string;
      nome?: string;
      email?: string;
      valor_sessao?: number;
    };
    type SessionItem = {
      id: string;
      id_paciente: string;
      data: string;
      valor: number | string;
      pago: boolean;
    };
    type ScriptElement = HTMLElement & {
      value?: string;
      checked?: boolean;
      disabled?: boolean;
      reset?: () => void;
      dataset?: DOMStringMap;
    };
    let patientMap = new Map();
    let patientDetails = new Map();
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;
    const byId = (id: string): ScriptElement =>
      document.getElementById(id) as ScriptElement;

    function fetchWithAuth(url: string, options: RequestInit = {}) {
      const tokenStr = localStorage.getItem("pb_auth");
      const auth = tokenStr ? JSON.parse(tokenStr).token : null;
      const headers = new Headers(options.headers ?? {});
      headers.set("Content-Type", "application/json");
      if (auth) headers.set("Authorization", `Bearer ${auth}`);
      return fetch(url, {...options, headers});
    }

    function getAuthData() {
      const tokenStr = localStorage.getItem("pb_auth");
      if (!tokenStr) return {token: null, userId: null};
      try {
        const parsed = JSON.parse(tokenStr);
        const token = parsed?.token || null;
        const userIdFromModel = parsed?.model?.id || parsed?.record?.id || null;

        if (userIdFromModel) return {token, userId: userIdFromModel};
        if (!token) return {token: null, userId: null};

        const tokenPayload = JSON.parse(
          atob(token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/")),
        );
        return {token, userId: tokenPayload?.id || null};
      } catch {
        return {token: null, userId: null};
      }
    }

    function parseCurrencyInput(value: string | number) {
      if (!value) return 0;
      const normalized = String(value)
        .replace(/\s/g, "")
        .replace("R$", "")
        .replace(/\./g, "")
        .replace(",", ".")
        .replace(/[^\d.-]/g, "");
      const parsed = Number(normalized);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatCurrencyInput(value: string | number) {
      const number = Number(value);
      if (!Number.isFinite(number)) return "";
      return `R$ ${number.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      })}`;
    }

    function attachCurrencyMask(input: HTMLInputElement | null) {
      if (!input) return;

      input.addEventListener("input", () => {
        input.value = input.value.replace(/[^\d,.-]/g, "");
      });

      input.addEventListener("focus", () => {
        const numeric = parseCurrencyInput(input.value);
        if (!numeric) {
          input.value = "";
          return;
        }

        input.value = Number.isInteger(numeric)
          ? String(numeric)
          : String(numeric).replace(".", ",");
      });

      input.addEventListener("blur", () => {
        if (!input.value.trim()) return;
        input.value = formatCurrencyInput(parseCurrencyInput(input.value));
      });
    }

    function isoToInputDate(isoString: string) {
      if (!isoString) return "";
      const date = new Date(isoString);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    }

    function formatDateDisplay(isoString: string) {
      if (!isoString) return "-";
      const date = new Date(isoString);
      const weekday = date.toLocaleDateString("pt-BR", {weekday: "long"});
      const day = date.toLocaleDateString("pt-BR", {day: "2-digit"});
      const month = date.toLocaleDateString("pt-BR", {month: "long"});
      const hour = date.toLocaleTimeString("pt-BR", {hour: "2-digit", hour12: false});
      const minute = date.toLocaleTimeString("pt-BR", {minute: "2-digit"});
      return `${weekday}, ${day} de ${month} às ${hour}h${minute}`;
    }

    async function init() {
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      const form = byId("session-form");
      if (!form || form.dataset.initialized) return;
      form.dataset.initialized = "true";

      const patientSelect = byId("id_paciente");
      const valorInput = byId("valor");
      attachCurrencyMask(valorInput as HTMLInputElement);

      try {
        await Promise.all([loadPatientsForSelect(), loadSessions()]);
      } catch (err) {
        console.error("Falha ao carregar dados iniciais:", err);
      }

      patientSelect?.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement | null;
        const patientId = target?.value ?? "";
        const sessionId = byId("session-id").value;

        if (!sessionId && patientId && patientDetails.has(patientId)) {
          const value = patientDetails.get(patientId).valor_sessao || 0;
          valorInput.value = formatCurrencyInput(value);
        }
      });

      byId("new-btn")?.addEventListener("click", () => {
        byId("session-id").value = "";
        if (form && typeof form.reset === "function") {
          form.reset();
        }
        sortPatientsForSelect();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        byId("data").value = now.toISOString().slice(0, 16);
        toggleForm(true);
      });

      document
        .getElementById("cancel-btn")
        ?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", handleFormSubmit);
      attachPerPageListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updatePaginationControls();
    }

    async function handleFormSubmit(ev: Event) {
      ev.preventDefault();
      const id = byId("session-id").value;
      const rawDate = byId("data").value;
      const utcDate = rawDate ? new Date(rawDate).toISOString() : "";

      const payload: Record<string, unknown> = {
        id_paciente: byId("id_paciente").value,
        data: utcDate,
        valor: parseCurrencyInput(byId("valor").value || ""),
        pago: byId("pago").checked,
      };

      if (!id) {
        const {userId} = getAuthData();
        if (userId) {
          payload.owner = userId;
        }
      }

      try {
        const url = id ? `${collectionBase}/${id}` : collectionBase;
        const res = await fetchWithAuth(url, {
          method: id ? "PUT" : "POST",
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Erro ao salvar");
        toggleForm(false);
        loadSessions(currentPage);
      } catch {
        alert("Erro ao salvar sessão.");
      }
    }

    function toggleForm(show: boolean) {
      document
        .getElementById("form-container")
        ?.classList.toggle("hidden", !show);
    }

    async function loadPatientsForSelect() {
      const firstParams = buildPaginationParams(1, 100);
      const firstRes = await fetchWithAuth(`/api/pacientes?${firstParams.toString()}`);
      const firstData = await firstRes.json();
      const firstPage = normalizePaginationData(firstData, 1, 100);
      let items = [...(firstPage.items as PacienteOption[])];

      for (let page = 2; page <= firstPage.totalPages; page += 1) {
        const params = buildPaginationParams(page, 100);
        const res = await fetchWithAuth(`/api/pacientes?${params.toString()}`);
        const data = await res.json();
        const normalized = normalizePaginationData<PacienteOption>(data, page, 100);
        items = items.concat(normalized.items);
      }

      items = sortPatientsByName(items);
      patientMap = new Map(
        items.map((p) => [p.id, p.nome || p.email || "Sem nome"]),
      );
      patientDetails = new Map(items.map((p) => [p.id, p]));

      const select = byId("id_paciente");
      if (select) {
        select.innerHTML =
          '<option value="">— selecione —</option>' +
          items
            .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
            .join("");
      }
    }

    function sortPatientsByName(items: PacienteOption[]) {
      return [...items].sort((a, b) =>
        (a?.nome || a?.email || "").localeCompare(b?.nome || b?.email || "", "pt-BR", {
          sensitivity: "base",
        }),
      );
    }

    function sortPatientsForSelect() {
      const items = sortPatientsByName(Array.from(patientDetails.values()));
      const select = byId("id_paciente");
      if (!select) return;

      const currentValue = select.value;
      select.innerHTML =
        '<option value="">— selecione —</option>' +
        items
          .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
          .join("");
      select.value = currentValue;
    }

    async function loadSessions(page = 1) {
      const body = byId("sessions-body");
      if (!body) return;
      try {
        const params = buildPaginationParams(page, perPage, { sort: "-data" });
        const res = await fetchWithAuth(`${collectionBase}?${params.toString()}`);
        const data = await res.json();
        const normalized = normalizePaginationData(data, page, perPage);
        currentPage = normalized.page;
        totalPages = normalized.totalPages;
        totalItems = normalized.totalItems;
        renderTable(normalized.items as SessionItem[]);
        updatePaginationControls();
        updateSessionCount();
      } catch (err) {
        console.error(err);
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
      }
    }

    function renderTable(items: SessionItem[]) {
      const body = byId("sessions-body");
      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhuma sessão registrada.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (it: SessionItem) => `
      <tr class="border-b transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
        <td class="p-3 font-medium text-gray-900 dark:text-gray-200">${patientMap.get(it.id_paciente) || "Desconhecido"}</td>
        <td class="p-3 text-gray-600 dark:text-gray-400">${formatDateDisplay(it.data)}</td>
        <td class="p-3 text-gray-600 dark:text-gray-400">${formatCurrencyInput(Number(it.valor) || 0)}</td>
        <td class="p-3 text-center">
          <button onclick="togglePaymentStatus('${it.id}', ${it.pago})" class="rounded-full border px-3 py-2 text-xs font-semibold ${it.pago ? "border-green-200 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300" : "border-red-200 bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"} transition hover:opacity-80">
            ${it.pago ? "PAGO" : "PENDENTE"}
          </button>
        </td>
        <td class="p-3 text-right">
          <div class="flex items-center justify-end gap-2 whitespace-nowrap">
            <button class="edit-btn inline-flex min-h-10 items-center justify-center rounded bg-yellow-400 px-3 py-2 text-sm font-medium text-gray-900 hover:bg-yellow-500" data-id="${it.id}">Editar</button>
            <button class="del-btn inline-flex min-h-10 items-center justify-center rounded bg-red-500 px-3 py-2 text-sm font-medium text-white hover:bg-red-600" data-id="${it.id}">Excluir</button>
          </div>
        </td>
      </tr>
    `,
        )
        .join("");
      attachRowListeners(items);
    }

    (window as any).togglePaymentStatus = async (id: string, currentStatus: boolean) => {
      try {
        await fetchWithAuth(`${collectionBase}/${id}`, {
          method: "PUT",
          body: JSON.stringify({pago: !currentStatus}),
        });
        loadSessions(currentPage);
      } catch {
        alert("Erro ao atualizar pagamento");
      }
    };

    function attachRowListeners(items: SessionItem[]) {
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i: SessionItem) => i.id === id);
          if (!record) return;

          byId("session-id").value = record.id;
          byId("id_paciente").value = record.id_paciente;
          byId("data").value = isoToInputDate(record.data);
          byId("valor").value = formatCurrencyInput(
            Number(record.valor) || 0,
          );
          byId("pago").checked = record.pago;

          toggleForm(true);
        });
      });

      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!confirm("Tem certeza que deseja excluir esta sessão?")) return;
          const id = btn.getAttribute("data-id");
          try {
            await fetchWithAuth(`${collectionBase}/${id}`, {method: "DELETE"});
            loadSessions(currentPage);
          } catch {
            alert("Erro ao excluir sessão");
          }
        });
      });
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadSessions(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadSessions(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadSessions(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-green-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-green-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn");
      const nextBtn = byId("next-page-btn");
      const pageIndicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) prevBtn.disabled = !view.canPrev;
      if (nextBtn) nextBtn.disabled = !view.canNext;
      if (pageIndicator) pageIndicator.textContent = view.indicator;
    }

    function updateSessionCount() {
      const countEl = byId("sessions-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>