---
import PageLayout from "~/layouts/PageLayout.astro";

const metadata = {
  title: "Sessões",
  description: "Cadastro e gerenciamento de sessões",
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-4xl py-12">
    <a
      href="/dashboard"
      class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:underline mb-3">
      ← Voltar ao Dashboard
    </a>
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Sessões</h1>
      <button
        id="new-btn"
        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
        >Nova sessão</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden bg-white dark:bg-gray-900 p-6 rounded shadow border dark:border-gray-800">
      <form id="session-form" class="space-y-4">
        <input type="hidden" id="session-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Paciente</label
          >
          <select
            id="id_paciente"
            class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500"
            required>
            <option value="">— selecione —</option>
          </select>
        </div>
        <div class="flex space-x-2">
          <div class="flex-1">
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Data e Hora</label
            >
            <input
              id="data"
              type="datetime-local"
              class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500"
              required
            />
          </div>
          <div class="w-40">
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Valor (R$)</label
            >
            <input
              id="valor"
              type="number"
              step="0.01"
              class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800 focus:ring-2 focus:ring-green-500"
            />
          </div>
        </div>
        <div>
          <label class="inline-flex items-center cursor-pointer">
            <input
              id="pago"
              type="checkbox"
              class="mr-2 w-4 h-4 text-green-600 rounded"
            />
            <span class="text-sm text-gray-700 dark:text-gray-300">Pago</span>
          </label>
        </div>
        <div class="flex items-center space-x-2 pt-2">
          <button
            type="submit"
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-400 dark:hover:bg-gray-600 transition"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div
      class="bg-white dark:bg-gray-900 rounded shadow p-4 border dark:border-gray-800 overflow-x-auto">
      <div class="mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="sessions-count">0</span> sessões
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por página:</span>
          <button
            type="button"
            class="per-page-btn px-3 py-1 rounded border text-sm"
            data-per-page="10">10</button>
          <button
            type="button"
            class="per-page-btn px-3 py-1 rounded border text-sm"
            data-per-page="50">50</button>
          <button
            type="button"
            class="per-page-btn px-3 py-1 rounded border text-sm"
            data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full text-left table-auto">
        <thead>
          <tr
            class="text-sm text-gray-600 dark:text-gray-400 border-b dark:border-gray-700">
            <th class="p-3">Paciente</th>
            <th class="p-3">Data</th>
            <th class="p-3">Valor</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="sessions-body" class="align-top text-sm">
          <tr
            ><td colspan="5" class="p-4 text-center text-gray-500"
              >Carregando sessões...</td
            ></tr
          >
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="px-3 py-1 rounded border text-sm disabled:opacity-50 disabled:cursor-not-allowed">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400">Página 1 de 1</span>
        <button
          id="next-page-btn"
          type="button"
          class="px-3 py-1 rounded border text-sm disabled:opacity-50 disabled:cursor-not-allowed">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script type="module">
    const collectionBase = "/api/sessoes";
    let patientMap = new Map();
    let patientDetails = new Map();
    let currentPage = 1;
    let perPage = 10;
    let totalPages = 1;
    let totalItems = 0;

    // --- FUNÇÕES AUXILIARES ---
    function fetchWithAuth(url, options = {}) {
      const tokenStr = localStorage.getItem("pb_auth");
      const auth = tokenStr ? JSON.parse(tokenStr).token : null;
      const headers = {"Content-Type": "application/json", ...options.headers};
      if (auth) headers.Authorization = `Bearer ${auth}`;
      return fetch(url, {...options, headers});
    }

    function getAuthData() {
      const tokenStr = localStorage.getItem("pb_auth");
      if (!tokenStr) return { token: null, userId: null };
      try {
        const parsed = JSON.parse(tokenStr);
        const token = parsed?.token || null;
        const userIdFromModel = parsed?.model?.id || null;

        if (userIdFromModel) return { token, userId: userIdFromModel };
        if (!token) return { token: null, userId: null };

        const tokenPayload = JSON.parse(
          atob(token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/")),
        );
        return { token, userId: tokenPayload?.id || null };
      } catch {
        return { token: null, userId: null };
      }
    }

    function isoToInputDate(isoString) {
      if (!isoString) return "";
      const date = new Date(isoString);
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    }

    function formatDateDisplay(isoString) {
      if (!isoString) return "-";
      return new Date(isoString).toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // --- LÓGICA DE INICIALIZAÇÃO ---
    async function init() {
      // 1. Verificação Instantânea de Auth via LocalStorage
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      // 2. Referências do DOM
      const form = document.getElementById("session-form");
      if (!form) return; // Garante que não quebra se o elemento sumir

      //carregando dados do paciente
      const patientSelect = document.getElementById("id_paciente");
      const valorInput = document.getElementById("valor");

      // 3. Carregar dados em paralelo (Melhora a performance)
      try {
        await Promise.all([loadPatientsForSelect(), loadSessions()]);
      } catch (err) {
        console.error("Falha ao carregar dados iniciais:", err);
      }

      // --- EVENT LISTENERS ---

      // 2. Listener para preencher o valor automaticamente ao selecionar paciente
      patientSelect?.addEventListener("change", (e) => {
        const patientId = e.target.value;
        const sessionId = document.getElementById("session-id").value;
        
        // Só preenche automaticamente se for uma NOVA sessão (ID vazio)
        // Isso evita sobrescrever valores de sessões antigas que tiveram preço diferenciado
        if (!sessionId && patientId && patientDetails.has(patientId)) {
          valorInput.value = patientDetails.get(patientId).valor_sessao || 0;
        }
      });

      // Usamos delegação ou verificação de existência para evitar erros de 'null'
      document.getElementById("new-btn")?.addEventListener("click", () => {
        document.getElementById("session-id").value = "";
        form.reset();
        sortPatientsForSelect();
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById("data").value = now.toISOString().slice(0, 16);
        toggleForm(true);
      });

      document
        .getElementById("cancel-btn")
        ?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", handleFormSubmit);
      attachPerPageListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updatePaginationControls();
    }

    // --- HANDLERS ---
    async function handleFormSubmit(ev) {
      ev.preventDefault();
      const id = document.getElementById("session-id").value;
      const rawDate = document.getElementById("data").value;
      const utcDate = rawDate ? new Date(rawDate).toISOString() : "";

      const payload = {
        id_paciente: document.getElementById("id_paciente").value,
        data: utcDate,
        valor: Number(document.getElementById("valor").value) || 0,
        pago: document.getElementById("pago").checked,
      };

      if (!id) {
        const { userId } = getAuthData();
        if (userId) {
          payload.owner = userId;
        }
      }

      try {
        const url = id ? `${collectionBase}/${id}` : collectionBase;
        const res = await fetchWithAuth(url, {
          method: id ? "PUT" : "POST",
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Erro ao salvar");
        toggleForm(false);
        loadSessions(currentPage);
      } catch (err) {
        alert("Erro ao salvar sessão.", err);
      }
    }

    function toggleForm(show) {
      document
        .getElementById("form-container")
        ?.classList.toggle("hidden", !show);
    }

    async function loadPatientsForSelect() {
      const res = await fetchWithAuth("/api/pacientes");
      const data = await res.json();
      const items = sortPatientsByName(data?.items || []);
      patientMap = new Map(
        items.map((p) => [p.id, p.nome || p.email || "Sem nome"]),
      );
      patientDetails = new Map(items.map((p) => [p.id, p]));

      const select = document.getElementById("id_paciente");
      if (select) {
        select.innerHTML =
          '<option value="">— selecione —</option>' +
          items
            .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
            .join("");
      }
    }

    function sortPatientsByName(items) {
      return [...items].sort((a, b) =>
        (a?.nome || a?.email || "").localeCompare(b?.nome || b?.email || "", "pt-BR", {
          sensitivity: "base",
        }),
      );
    }

    function sortPatientsForSelect() {
      const items = sortPatientsByName(Array.from(patientDetails.values()));
      const select = document.getElementById("id_paciente");
      if (!select) return;

      const currentValue = select.value;
      select.innerHTML =
        '<option value="">— selecione —</option>' +
        items
          .map((p) => `<option value="${p.id}">${p.nome || p.email}</option>`)
          .join("");
      select.value = currentValue;
    }

    async function loadSessions(page = 1) {
      const body = document.getElementById("sessions-body");
      if (!body) return;
      try {
        const params = new URLSearchParams({
          sort: "-data",
          page: String(page),
          perPage: String(perPage),
        });
        const res = await fetchWithAuth(`${collectionBase}?${params.toString()}`);
        const data = await res.json();
        currentPage = Number(data?.page || page);
        totalPages = Math.max(1, Number(data?.totalPages || 1));
        totalItems = Number(data?.totalItems || 0);
        renderTable(data?.items || []);
        updatePaginationControls();
        updateSessionCount();
      } catch (err) {
        console.error(err);
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
      }
    }

    function renderTable(items) {
      const body = document.getElementById("sessions-body");
      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhuma sessão registrada.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (it) => `
      <tr class="border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
        <td class="p-3 font-medium text-gray-900 dark:text-gray-200">${patientMap.get(it.id_paciente) || "Desconhecido"}</td>
        <td class="p-3 text-gray-600 dark:text-gray-400">${formatDateDisplay(it.data)}</td>
        <td class="p-3 text-gray-600 dark:text-gray-400">R$ ${Number(it.valor).toFixed(2)}</td>
        <td class="p-3 text-center">
          <button onclick="togglePaymentStatus('${it.id}', ${it.pago})" class="px-3 py-1 rounded-full text-xs font-semibold border ${it.pago ? "bg-green-100 text-green-800 border-green-200 dark:bg-green-900 dark:text-green-300" : "bg-red-100 text-red-800 border-red-200 dark:bg-red-900 dark:text-red-300"} hover:opacity-80 transition">
            ${it.pago ? "PAGO" : "PENDENTE"}
          </button>
        </td>
        <td class="p-3 text-right space-x-2">
          <button class="edit-btn text-blue-600 hover:text-blue-800 text-sm font-medium" data-id="${it.id}">Editar</button>
          <button class="del-btn text-red-600 hover:text-red-800 text-sm font-medium" data-id="${it.id}">Excluir</button>
        </td>
      </tr>
    `,
        )
        .join("");
      attachRowListeners(items);
    }

    // listeners de edição e exclusão omitidos aqui por brevidade, permanecem iguais
    // Tornar a função global para ser acessada pelo onclick inline do HTML
    window.togglePaymentStatus = async (id, currentStatus) => {
      try {
        await fetchWithAuth(`${collectionBase}/${id}`, {
          method: "PUT",
          body: JSON.stringify({pago: !currentStatus}),
        });
        loadSessions(currentPage); // Atualiza apenas a tabela
      } catch (err) {
        alert("Erro ao atualizar pagamento", err);
      }
    };

    function attachRowListeners(items) {
      // Editar
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i) => i.id === id);
          if (!record) return;

          document.getElementById("session-id").value = record.id;
          document.getElementById("id_paciente").value = record.id_paciente;
          document.getElementById("data").value = isoToInputDate(record.data); // Converte UTC -> Input Local
          document.getElementById("valor").value = record.valor;
          document.getElementById("pago").checked = record.pago;

          toggleForm(true);
        });
      });

      // Excluir
      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!confirm("Tem certeza que deseja excluir esta sessão?")) return;
          const id = btn.getAttribute("data-id");
          try {
            await fetchWithAuth(`${collectionBase}/${id}`, {method: "DELETE"});
            loadSessions(currentPage);
          } catch (err) {
            alert("Erro ao excluir sessão:", err);
          }
        });
      });
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = Number(btn.getAttribute("data-per-page")) || 10;
          currentPage = 1;
          updatePerPageButtons();
          loadSessions(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      document.getElementById("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadSessions(currentPage - 1);
      });

      document.getElementById("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadSessions(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-green-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-green-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = document.getElementById("prev-page-btn");
      const nextBtn = document.getElementById("next-page-btn");
      const pageIndicator = document.getElementById("page-indicator");

      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      if (pageIndicator) pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;
    }

    function updateSessionCount() {
      const countEl = document.getElementById("sessions-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    // --- O PURO PULP DO ASTRO ---
    // Escuta tanto o carregamento inicial quanto as transições do Astro
    document.addEventListener("astro:page-load", init);
    // Fallback para quando não se usa ViewTransitions
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
