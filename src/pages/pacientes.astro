---
import PageLayout from "~/layouts/PageLayout.astro";

const metadata = {
  title: "Pacientes",
  description: "Cadastro e gerenciamento de pacientes",
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400"
      >← Voltar ao Dashboard</a
    >

    <div class="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">
        Pacientes
      </h1>
      <button
        id="new-btn"
        class="inline-flex min-h-11 items-center justify-center rounded bg-blue-600 px-4 py-2 text-white transition hover:bg-blue-700"
        >Novo paciente</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded border bg-white p-4 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-6">
      <form id="patient-form" class="space-y-4">
        <input type="hidden" id="patient-id" />

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Nome *</label
            >
            <input
              id="nome"
              required
              placeholder="Ex.: Maria da Silva"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Email</label
            >
            <input
              id="email"
              type="email"
              placeholder="Ex.: maria@email.com"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Contato</label
            >
            <input
              id="contato"
              placeholder="Ex.: (11) 99999-9999"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Endereço</label
            >
            <input
              id="endereco"
              placeholder="Ex.: Rua Exemplo, 123"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Nascimento</label
            >
            <input
              id="data_nascimento"
              type="date"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Início *</label
            >
            <input
              id="data_inicio"
              type="date"
              required
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Valor sessão (R$)</label
            >
            <input
              id="valor_sessao"
              type="text"
              inputmode="decimal"
              placeholder="R$ 12,00"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="flex items-center pt-6">
            <input
              id="ativo"
              type="checkbox"
              checked
              class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Paciente Ativo</label
            >
          </div>
        </div>

        <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center">
          <button
            type="submit"
            class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="inline-flex min-h-11 items-center justify-center rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="patients-count">0</span> pacientes
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por página:</span>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="20">20</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="50">50</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-2">Nome</th>
            <th class="p-2">Contato</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Status</th>
            <th class="p-2 text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="patients-body" class="align-top text-sm">
          <tr>
            <td colspan="5" class="p-4 text-center text-sm text-gray-500"
              >Carregando...</td
            >
          </tr>
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400">Página 1 de 1</span>
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script>
    import {
      buildPaginationParams,
      getPaginationView,
      getPerPageValue,
      normalizePaginationData,
    } from "~/services/paginationService";

    const collectionBase = "/api/pacientes";
    
    type PacienteItem = {
      id: string;
      nome?: string;
      email?: string;
      contato?: string;
      endereco?: string;
      data_nascimento?: string;
      data_inicio?: string;
      valor_sessao?: number | string;
      ativo?: boolean;
    };
    
    type ScriptElement = HTMLElement & {
      value?: string;
      checked?: boolean;
      disabled?: boolean;
      reset?: () => void;
      dataset?: DOMStringMap;
    };
    
    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;
    
    const byId = (id: string): ScriptElement =>
      document.getElementById(id) as ScriptElement;

    function getTokenFromLocalStorage(): string | null {
      const tokenStr = localStorage.getItem("pb_auth");
      if (!tokenStr) return null;

      try {
        const parsed = JSON.parse(tokenStr);
        return parsed?.token || null;
      } catch {
        return tokenStr;
      }
    }

    function fetchWithAuth(url: string, options: RequestInit = {}) {
      const token = getTokenFromLocalStorage();
      const headers = new Headers(options.headers ?? {});
      headers.set("Content-Type", "application/json");
      if (token) headers.set("Authorization", `Bearer ${token}`);
      return fetch(url, {...options, headers});
    }

    function formatDateForInput(dateString: string): string {
      if (!dateString) return "";
      return dateString.split(" ")[0];
    }

    function parseCurrencyInput(value: string | number): number {
      if (!value) return 0;
      const normalized = String(value)
        .replace(/\s/g, "")
        .replace("R$", "")
        .replace(/\./g, "")
        .replace(",", ".")
        .replace(/[^\d.-]/g, "");
      const parsed = Number(normalized);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function formatCurrencyInput(value: string | number): string {
      const number = Number(value);
      if (!Number.isFinite(number)) return "";
      return `R$ ${number.toLocaleString("pt-BR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      })}`;
    }

    function attachCurrencyMask(input: HTMLInputElement | null) {
      if (!input) return;

      input.addEventListener("input", () => {
        input.value = input.value.replace(/[^\d,.-]/g, "");
      });

      input.addEventListener("focus", () => {
        const numeric = parseCurrencyInput(input.value);
        if (!numeric) {
          input.value = "";
          return;
        }

        input.value = Number.isInteger(numeric)
          ? String(numeric)
          : String(numeric).replace(".", ",");
      });

      input.addEventListener("blur", () => {
        if (!input.value.trim()) return;
        input.value = formatCurrencyInput(parseCurrencyInput(input.value));
      });
    }

    async function init() {
      const form = byId("patient-form");
      const body = byId("patients-body");
      const valueInput = byId("valor_sessao");
      if (!form || !body || form.dataset.initialized) return;

      form.dataset.initialized = "true";
      attachCurrencyMask(valueInput as HTMLInputElement);
      setupUIListeners(form as HTMLFormElement);
      attachPerPageListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updatePaginationControls();
      loadPatients();
    }

    function setupUIListeners(form: HTMLFormElement) {
      byId("new-btn")?.addEventListener("click", () => {
        byId("patient-id").value = "";
        form.reset();
        byId("ativo").checked = true;
        toggleForm(true);
      });

      document
        .getElementById("cancel-btn")
        ?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", async (ev: Event) => {
        ev.preventDefault();

        const id = byId("patient-id").value;
        const dataNasc = byId("data_nascimento").value;
        const dataInicio = byId("data_inicio").value;

        const payload: Record<string, unknown> = {
          nome: byId("nome").value,
          email: byId("email").value,
          contato: byId("contato").value,
          endereco: byId("endereco").value,
          valor_sessao: parseCurrencyInput(
            byId("valor_sessao").value || "",
          ),
          ativo: byId("ativo").checked,
        };

        if (dataNasc) payload.data_nascimento = `${dataNasc} 12:00:00.000Z`;
        if (dataInicio) payload.data_inicio = `${dataInicio} 12:00:00.000Z`;

        try {
          const url = id ? `${collectionBase}/${id}` : collectionBase;
          const res = await fetchWithAuth(url, {
            method: id ? "PUT" : "POST",
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error("Erro ao salvar");

          toggleForm(false);
          loadPatients(currentPage);
        } catch (err) {
          console.error(err);
          alert("Erro ao salvar paciente.");
        }
      });
    }

    async function loadPatients(page = 1) {
      const body = byId("patients-body");
      try {
        const params = buildPaginationParams(page, perPage);
        const res = await fetchWithAuth(`${collectionBase}?${params.toString()}`);
        const data = await res.json();
        const normalized = normalizePaginationData(data, page, perPage);
        currentPage = normalized.page;
        totalPages = normalized.totalPages;
        totalItems = normalized.totalItems;
        render(normalized.items as PacienteItem[]);
        updatePaginationControls();
        updatePatientsCount();
      } catch (err) {
        console.error(err);
        if (body)
          body.innerHTML =
            '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
      }
    }

    function render(items: PacienteItem[]) {
      const body = byId("patients-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum paciente cadastrado.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (it: PacienteItem) => `
        <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
          <td class="p-2 dark:text-gray-300">
            <div class="font-medium">${it.nome || ""}</div>
            <div class="text-xs text-gray-500">${it.email || ""}</div>
          </td>
          <td class="p-2 dark:text-gray-300">${it.contato || ""}</td>
          <td class="p-2 dark:text-gray-300">${formatCurrencyInput(Number(it.valor_sessao) || 0)}</td>
          <td class="p-2">
            <span class="rounded px-2 py-1 text-xs ${it.ativo ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}">
              ${it.ativo ? "Ativo" : "Inativo"}
            </span>
          </td>
          <td class="p-2">
            <div class="flex items-center justify-end gap-2 whitespace-nowrap">
              <button data-id="${it.id}" class="edit-btn inline-flex min-h-10 items-center justify-center rounded bg-yellow-400 px-3 py-2 text-sm text-gray-900 transition hover:bg-yellow-500">Editar</button>
              <button data-id="${it.id}" class="del-btn inline-flex min-h-10 items-center justify-center rounded bg-red-500 px-3 py-2 text-sm text-white transition hover:bg-red-600">Excluir</button>
            </div>
          </td>
        </tr>
      `,
        )
        .join("");

      attachRowListeners(items);
    }

    function attachRowListeners(items: PacienteItem[]) {
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i: PacienteItem) => i.id === id);
          if (!record) return;

          byId("patient-id").value = record.id;
          byId("nome").value = record.nome || "";
          byId("email").value = record.email || "";
          byId("contato").value = record.contato || "";
          byId("endereco").value = record.endereco || "";
          byId("valor_sessao").value = formatCurrencyInput(
            Number(record.valor_sessao) || 0,
          );

          byId("data_nascimento").value = formatDateForInput(
            record.data_nascimento || "",
          );
          byId("data_inicio").value = formatDateForInput(
            record.data_inicio || "",
          );
          byId("ativo").checked = record.ativo !== false;

          toggleForm(true);
        });
      });

      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Deseja realmente excluir este paciente?")) return;

          try {
            const res = await fetchWithAuth(`${collectionBase}/${id}`, {
              method: "DELETE",
            });
            if (res.ok) loadPatients(currentPage);
          } catch (err) {
            console.error(err);
            alert("Erro ao excluir paciente.");
          }
        });
      });
    }

    function toggleForm(show: boolean) {
      document
        .getElementById("form-container")
        ?.classList.toggle("hidden", !show);
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadPatients(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadPatients(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadPatients(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn");
      const nextBtn = byId("next-page-btn");
      const indicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) prevBtn.disabled = !view.canPrev;
      if (nextBtn) nextBtn.disabled = !view.canNext;
      if (indicator) indicator.textContent = view.indicator;
    }

    function updatePatientsCount() {
      const countEl = byId("patients-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
