---
import PageLayout from "~/layouts/PageLayout.astro";
const metadata = {
  title: "Pacientes",
  description: "Cadastro e gerenciamento de pacientes",
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-4xl py-12">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400"
      >← Voltar ao Dashboard</a
    >

    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        Pacientes
      </h1>
      <button id="new-btn" class="rounded bg-blue-600 px-4 py-2 text-white transition hover:bg-blue-700"
        >Novo paciente</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded bg-white p-6 shadow dark:bg-gray-900">
      <form id="patient-form" class="space-y-4">
        <input type="hidden" id="patient-id" />

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Nome *</label
            >
            <input
              id="nome"
              required
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Email</label
            >
            <input
              id="email"
              type="email"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Contato</label
            >
            <input
              id="contato"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Endereço</label
            >
            <input
              id="endereco"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Nascimento</label
            >
            <input
              id="data_nascimento"
              type="date"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Início *</label
            >
            <input
              id="data_inicio"
              type="date"
              required
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Valor sessão (R$)</label
            >
            <input
              id="valor_sessao"
              type="number"
              step="0.01"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="flex items-center pt-6">
            <input
              id="ativo"
              type="checkbox"
              checked
              class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Paciente Ativo</label
            >
          </div>
        </div>

        <div class="mt-4 flex items-center space-x-2">
          <button
            type="submit"
            class="rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div class="overflow-x-auto rounded bg-white p-4 shadow dark:bg-gray-900">
      <table class="w-full table-auto text-left">
        <thead>
          <tr class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-2">Nome</th>
            <th class="p-2">Contato</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Status</th>
            <th class="p-2">Ações</th>
          </tr>
        </thead>
        <tbody id="patients-body" class="align-top">
          <tr>
            <td colspan="5" class="p-4 text-center text-sm text-gray-500"
              >Carregando...</td
            >
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <script type="module">
    //collectionBase é a base da URL para as operações CRUD, facilitando manutenção e leitura do código
    const collectionBase = "/api/pacientes";

    // --- HELPER FUNCTIONS ---
    function fetchWithAuth(url, options = {}) {
      // Como o Astro já lida com os cookies (se houver), ou extrai do Header, 
      // mantemos apenas o token se você usar localStorage
      const tokenStr = localStorage.getItem("pb_auth");
      
      // Limpa a string do token caso ela seja um JSON ou JWT puro
      let token = null;
      try {
        const parsed = JSON.parse(tokenStr);
        token = parsed.token || parsed; // se for objeto pega .token, se for o JWT puro pega ele
      } catch (e) {
        console.warn("Token não é JSON, usando como JWT direto.", e);
        token = tokenStr; // se não for JSON, é o JWT direto
      }

      const headers = { "Content-Type": "application/json", ...options.headers };
      if (token) headers.Authorization = `Bearer ${token}`;
      
      return fetch(url, { ...options, headers });
    }

    function formatDateForInput(dateString) {
      if (!dateString) return "";
      return dateString.split(" ")[0]; 
    }

    // --- LÓGICA PRINCIPAL ---
    async function init() {
      // TRAVA DE DUPLA EXECUÇÃO: Evita que os eventos sejam atrelados 2 vezes
      const form = document.getElementById("patient-form");
      const body = document.getElementById("patients-body");
      if (!form || !body || form.dataset.initialized) return;
      
      form.dataset.initialized = "true"; // Marca como inicializado

      setupUIListeners(form);
      loadPatients();
    }

    function setupUIListeners(form) {
      document.getElementById("new-btn")?.addEventListener("click", () => {
        document.getElementById("patient-id").value = "";
        form.reset();
        document.getElementById("ativo").checked = true;
        toggleForm(true);
      });

      document.getElementById("cancel-btn")?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        
        const id = document.getElementById("patient-id").value;
        const dataNasc = document.getElementById("data_nascimento").value;
        const dataInicio = document.getElementById("data_inicio").value;

        // O 'owner' agora é inserido automaticamente no Backend
        const payload = {
          nome: document.getElementById("nome").value,
          email: document.getElementById("email").value,
          contato: document.getElementById("contato").value,
          endereco: document.getElementById("endereco").value,
          valor_sessao: Number(document.getElementById("valor_sessao").value) || 0,
          ativo: document.getElementById("ativo").checked,
        };

        if (dataNasc) payload.data_nascimento = `${dataNasc} 12:00:00.000Z`;
        if (dataInicio) payload.data_inicio = `${dataInicio} 12:00:00.000Z`;

        try {
          const url = id ? `${collectionBase}/${id}` : collectionBase;
          const res = await fetchWithAuth(url, {
            method: id ? "PUT" : "POST",
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error("Erro ao salvar");
          
          toggleForm(false);
          loadPatients();
        } catch (err) {
          console.error(err);
          alert("Erro ao salvar paciente.");
        }
      });
    }

    async function loadPatients() {
      const body = document.getElementById("patients-body");
      try {
        const res = await fetchWithAuth(collectionBase);
        const data = await res.json();
        render(data?.items || []);
      } catch (err) {
        console.error(err);
        if (body)
          body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
      }
    }

    function render(items) {
      const body = document.getElementById("patients-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum paciente cadastrado.</td></tr>';
        return;
      }

      body.innerHTML = items.map((it) => `
        <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
          <td class="p-2 dark:text-gray-300">
            <div class="font-medium">${it.nome || ""}</div>
            <div class="text-xs text-gray-500">${it.email || ""}</div>
          </td>
          <td class="p-2 dark:text-gray-300">${it.contato || ""}</td>
          <td class="p-2 dark:text-gray-300">R$ ${Number(it.valor_sessao).toFixed(2)}</td>
          <td class="p-2">
            <span class="px-2 py-1 text-xs rounded ${it.ativo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${it.ativo ? 'Ativo' : 'Inativo'}
            </span>
          </td>
          <td class="p-2">
            <button data-id="${it.id}" class="edit-btn mr-2 rounded bg-yellow-400 px-2 py-1 text-gray-900 transition hover:bg-yellow-500">Editar</button>
            <button data-id="${it.id}" class="del-btn rounded bg-red-500 px-2 py-1 text-white transition hover:bg-red-600">Excluir</button>
          </td>
        </tr>
      `).join("");

      attachRowListeners(items);
    }

    function attachRowListeners(items) {
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i) => i.id === id);
          if (!record) return;

          document.getElementById("patient-id").value = record.id;
          document.getElementById("nome").value = record.nome || "";
          document.getElementById("email").value = record.email || "";
          document.getElementById("contato").value = record.contato || "";
          document.getElementById("endereco").value = record.endereco || "";
          document.getElementById("valor_sessao").value = record.valor_sessao || "";
          
          document.getElementById("data_nascimento").value = formatDateForInput(record.data_nascimento);
          document.getElementById("data_inicio").value = formatDateForInput(record.data_inicio);
          document.getElementById("ativo").checked = record.ativo !== false;
          
          toggleForm(true);
        });
      });

      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Deseja realmente excluir este paciente?")) return;

          try {
            const res = await fetchWithAuth(`${collectionBase}/${id}`, { method: "DELETE" });
            if (res.ok) loadPatients();
          } catch (err) {
            console.error(err);
            alert("Erro ao excluir paciente.");
          }
        });
      });
    }

    function toggleForm(show) {
      document.getElementById("form-container")?.classList.toggle("hidden", !show);
    }

    // --- CICLO DE VIDA ASTRO (Limpo) ---
    document.addEventListener("astro:page-load", init);
    // Removemos os document.addEventListener("DOMContentLoaded") duplicados
    // para evitar que rode duas vezes!
  </script>
</PageLayout>