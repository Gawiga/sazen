---
import PageLayout from "~/layouts/PageLayout.astro";
import Loading from "~/components/widgets/Loading.astro";

const metadata = {
  title: "Pacientes",
  description: "Cadastro e gerenciamento de pacientes",
};
---

<PageLayout metadata={metadata}>
  <Loading />
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <a
      href="/dashboard"
      class="mb-3 inline-flex items-center text-sm text-gray-600 hover:underline dark:text-gray-400"
      >← Voltar ao Dashboard</a
    >

    <div class="mb-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">
        Pacientes
      </h1>
      <button
        id="new-btn"
        class="inline-flex min-h-11 items-center justify-center rounded bg-blue-600 px-4 py-2 text-white transition hover:bg-blue-700"
        >Novo paciente</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden rounded border bg-white p-4 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-6">
      <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Preencha os dados do paciente. Os campos marcados com <span class="font-bold">*</span> são obrigatórios.
      </p>
      <form id="patient-form" class="space-y-4">
        <input type="hidden" id="patient-id" />

        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Nome *</label
            >
            <input
              id="nome"
              required
              placeholder="Ex.: Maria da Silva"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Email</label
            >
            <input
              id="email"
              type="email"
              placeholder="Ex.: maria@email.com"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Contato</label
            >
            <input
              id="contato"
              placeholder="Ex.: (11) 99999-9999"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Endereço</label
            >
            <input
              id="endereco"
              placeholder="Ex.: Rua Exemplo, 123"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Nascimento</label
            >
            <input
              id="data_nascimento"
              type="date"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Data de Início *</label
            >
            <input
              id="data_inicio"
              type="date"
              required
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Valor sessão (R$)</label
            >
            <input
              id="valor_sessao"
              type="text"
              inputmode="decimal"
              placeholder="R$ 12,00"
              class="mt-1 w-full rounded border bg-white p-2 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
            />
          </div>

          <div class="flex items-center pt-6">
            <input
              id="ativo"
              type="checkbox"
              checked
              class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <label class="ml-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Paciente Ativo</label
            >
          </div>
        </div>

        <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center">
          <button
            type="submit"
            class="inline-flex min-h-11 items-center justify-center rounded bg-green-600 px-4 py-2 text-white transition hover:bg-green-700"
            >Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="inline-flex min-h-11 items-center justify-center rounded bg-gray-300 px-4 py-2 text-gray-800 transition hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div
        id="patients-info-banner"
        class="mb-4 flex items-start justify-between gap-3 rounded bg-blue-50 p-3 text-sm text-blue-800 dark:bg-blue-900 dark:text-blue-200">
        <p>
          <strong>Dica:</strong> Use o menu de ações (botão com barras) na coluna "Ações" para editar ou excluir um paciente.
        </p>
        <button
          id="close-patients-banner"
          type="button"
          class="inline-flex h-6 w-6 items-center justify-center rounded border border-blue-300 text-blue-700 transition hover:bg-blue-100 dark:border-blue-700 dark:text-blue-200 dark:hover:bg-blue-800"
          aria-label="Fechar dica">
          ×
        </button>
      </div>

      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="patients-count">0</span> pacientes
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Status:</span>
          <button
            type="button"
            class="status-filter-btn rounded border px-3 py-1 text-sm"
            data-status="ativo">Ativo</button>
          <button
            type="button"
            class="status-filter-btn rounded border px-3 py-1 text-sm"
            data-status="inativo">Inativo</button>
          <button
            type="button"
            class="status-filter-btn rounded border px-3 py-1 text-sm"
            data-status="todos">Todos</button>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por página:</span>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="20">20</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="50">50</button>
          <button
            type="button"
            class="per-page-btn rounded border px-3 py-1 text-sm"
            data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-2">Nome</th>
            <th class="p-2 text-right">Ações</th>
          </tr>
        </thead>
        <tbody id="patients-body" class="align-top text-sm">
          <tr>
            <td colspan="2" class="p-4 text-center text-sm text-gray-500"
              >Carregando...</td
            >
          </tr>
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400">Página 1 de 1</span>
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script>
    import {
      getPaginationView,
      getPerPageValue,
    } from "~/services/paginationService";
    import { PatientService } from "~/services/patientService";
    import { scrollToElement } from "~/services/uiService";
    import {
      formatCurrency,
      parseCurrency,
      formatDateForInput,
      attachCurrencyMask,
      getFormElement,
      toggleElement,
    } from "~/utils/formatting";
    import type { Paciente } from "~/types/api";

    const formContainerId = "form-container";

    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;
    let statusFilter: "ativo" | "inativo" | "todos" = "ativo";

    const byId = (id: string) => getFormElement(id);

    async function loadPatients(page = 1) {
      const body = byId("patients-body");
      try {
        const data = await PatientService.getPatients(page, perPage, statusFilter);

        currentPage = data.page;
        totalPages = data.totalPages;
        totalItems = data.totalItems;

        render(data.items);
        updatePaginationControls();
        updatePatientsCount();
      } catch (err) {
        console.error(err);
        if (body) {
          body.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
        }
      }
    }

    async function init() {
      const form = byId("patient-form");
      const body = byId("patients-body");
      const valueInput = byId("valor_sessao");
      if (!form || !body || form.dataset.initialized) return;

      form.dataset.initialized = "true";
      attachCurrencyMask(valueInput as HTMLInputElement);
      setupUIListeners(form as HTMLFormElement);
      attachPerPageListeners();
      attachStatusFilterListeners();
      attachPaginationListeners();
      updatePerPageButtons();
      updateStatusFilterButtons();
      updatePaginationControls();
      attachBannerListeners();
      loadPatients();
    }

    function setupUIListeners(form: HTMLFormElement) {
      byId("new-btn")?.addEventListener("click", () => {
        byId("patient-id").value = "";
        form.reset();
        byId("ativo").checked = true;
        toggleForm(true);
        scrollToElement(formContainerId);
      });

      document.getElementById("cancel-btn")?.addEventListener("click", () => toggleForm(false));

      form.addEventListener("submit", async (ev: Event) => {
        ev.preventDefault();

        const id = byId("patient-id").value || undefined;
        const dataNasc = byId("data_nascimento").value;
        const dataInicio = byId("data_inicio").value;

        const payload: Partial<Paciente> = {
          nome: byId("nome").value,
          email: byId("email").value,
          contato: byId("contato").value,
          endereco: byId("endereco").value,
          valor_sessao: parseCurrency(byId("valor_sessao").value || ""),
          ativo: byId("ativo").checked,
        };

        if (dataNasc) {
          payload.data_nascimento = `${dataNasc} 12:00:00.000Z`;
        }
        if (dataInicio) {
          payload.data_inicio = `${dataInicio} 12:00:00.000Z`;
        }

        try {
          if (id) {
            await PatientService.updatePatient(id, payload);
          } else {
            await PatientService.createPatient(payload);
          }
          toggleForm(false);
          loadPatients(currentPage);
        } catch (err) {
          console.error(err);
          alert("Erro ao salvar paciente.");
        }
      });
    }



    function render(items: Paciente[]) {
      const body = byId("patients-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="2" class="p-4 text-center text-gray-500">Nenhum paciente cadastrado.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (it) => `
        <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
          <td class="p-2 dark:text-gray-300">
            <div class="font-medium">${it.nome || ""}</div>
            <div class="text-xs text-gray-500">${it.email || ""}</div>
          </td>
          <td class="p-2 text-right">
            <details class="row-actions-menu relative inline-block text-left">
              <summary
                class="inline-flex min-h-10 min-w-10 cursor-pointer list-none items-center justify-center rounded border border-gray-300 bg-white px-2 py-2 text-gray-700 transition hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700"
                aria-label="Abrir ações do paciente ${it.nome || ""}"
                title="Abrir ações">
                <span class="sr-only">Abrir ações</span>
                <span class="inline-flex flex-col gap-1" aria-hidden="true">
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                  <span class="block h-0.5 w-4 rounded bg-current"></span>
                </span>
              </summary>
              <div class="absolute right-0 z-10 mt-1 w-44 rounded border bg-white p-1 shadow-lg dark:border-gray-700 dark:bg-gray-800">
                <button data-id="${it.id}" class="edit-btn block w-full rounded px-3 py-2 text-left text-sm text-gray-800 transition hover:bg-yellow-100 dark:text-gray-200 dark:hover:bg-gray-700">Editar</button>
                <button data-id="${it.id}" class="del-btn block w-full rounded px-3 py-2 text-left text-sm text-red-600 transition hover:bg-red-50 dark:text-red-400 dark:hover:bg-gray-700">Excluir</button>
              </div>
            </details>
          </td>
        </tr>
      `,
        )
        .join("");

      attachRowListeners(items);
    }

    function attachRowListeners(items: Paciente[]) {
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i) => i.id === id);
          if (!record) return;

          byId("patient-id").value = record.id || "";
          byId("nome").value = record.nome || "";
          byId("email").value = record.email || "";
          byId("contato").value = record.contato || "";
          byId("endereco").value = record.endereco || "";
          byId("valor_sessao").value = formatCurrency(Number(record.valor_sessao) || 0);

          byId("data_nascimento").value = formatDateForInput(record.data_nascimento || "");
          byId("data_inicio").value = formatDateForInput(record.data_inicio || "");
          byId("ativo").checked = record.ativo !== false;

          toggleForm(true);
          scrollToElement(formContainerId);
          (btn.closest("details") as HTMLDetailsElement | null)?.removeAttribute("open");
        });
      });

      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Deseja realmente excluir este paciente?")) return;

          try {
            await PatientService.deletePatient(id || "");
            loadPatients(currentPage);
            (btn.closest("details") as HTMLDetailsElement | null)?.removeAttribute("open");
          } catch (err) {
            console.error(err);
            alert("Erro ao excluir paciente.");
          }
        });
      });
    }

    function toggleForm(show: boolean) {
      toggleElement(formContainerId, show);
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadPatients(currentPage);
        });
      });
    }

    function attachStatusFilterListeners() {
      document.querySelectorAll(".status-filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const selected = btn.getAttribute("data-status");
          if (selected === "ativo" || selected === "inativo" || selected === "todos") {
            statusFilter = selected;
          } else {
            statusFilter = "ativo";
          }

          currentPage = 1;
          updateStatusFilterButtons();
          loadPatients(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadPatients(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadPatients(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updateStatusFilterButtons() {
      document.querySelectorAll(".status-filter-btn").forEach((btn) => {
        const isActive = btn.getAttribute("data-status") === statusFilter;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn");
      const nextBtn = byId("next-page-btn");
      const indicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) prevBtn.disabled = !view.canPrev;
      if (nextBtn) nextBtn.disabled = !view.canNext;
      if (indicator) indicator.textContent = view.indicator;
    }

    function updatePatientsCount() {
      const countEl = byId("patients-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    function attachBannerListeners() {
      byId("close-patients-banner")?.addEventListener("click", () => {
        byId("patients-info-banner")?.classList.add("hidden");
      });
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
