---
import PageLayout from "~/layouts/PageLayout.astro";

const metadata = {
  title: "Pacientes",
  description: "Cadastro e gerenciamento de pacientes",
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-4xl py-12">
    <a
      href="/dashboard"
      class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:underline mb-3"
      >← Voltar ao Dashboard</a
    >
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        Pacientes
      </h1>
      <button id="new-btn" class="px-4 py-2 bg-blue-600 text-white rounded"
        >Novo paciente</button
      >
    </div>

    <div
      id="form-container"
      class="mb-6 hidden bg-white dark:bg-gray-900 p-6 rounded shadow">
      <form id="patient-form" class="space-y-4">
        <input type="hidden" id="patient-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Nome</label
          >
          <input
            id="nome"
            class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300"
            >Email</label
          >
          <input
            id="email"
            class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800"
          />
        </div>
        <div class="flex space-x-2">
          <div class="flex-1">
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Contato</label
            >
            <input
              id="contato"
              class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800"
            />
          </div>
          <div class="w-40">
            <label class="block text-sm text-gray-700 dark:text-gray-300"
              >Valor sessão</label
            >
            <input
              id="valor_sessao"
              type="number"
              class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800"
            />
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button
            type="submit"
            class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button
          >
          <button
            id="cancel-btn"
            type="button"
            class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded"
            >Cancelar</button
          >
        </div>
      </form>
    </div>

    <div class="bg-white dark:bg-gray-900 rounded shadow p-4">
      <table class="w-full text-left table-auto">
        <thead>
          <tr class="text-sm text-gray-600 dark:text-gray-400">
            <th class="p-2">Nome</th>
            <th class="p-2">Email</th>
            <th class="p-2">Contato</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Ações</th>
          </tr>
        </thead>
        <tbody id="patients-body" class="align-top">
          <tr
            ><td colspan="5" class="p-4 text-center text-sm text-gray-500"
              >Carregando...</td
            ></tr
          >
        </tbody>
      </table>
    </div>
  </section>

  <script type="module">
    const collectionBase = "/api/pacientes";

    // --- HELPER FUNCTIONS ---
    function fetchWithAuth(url, options = {}) {
      const tokenStr = localStorage.getItem("pb_auth");
      const auth = tokenStr ? JSON.parse(tokenStr).token : null;
      const headers = {"Content-Type": "application/json", ...options.headers};
      if (auth) headers.Authorization = `Bearer ${auth}`;
      return fetch(url, {...options, headers});
    }

    // --- LÓGICA PRINCIPAL ---
    async function init() {
      // 1. Verificação Instantânea via LocalStorage
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      // 2. Elementos do DOM
      const form = document.getElementById("patient-form");
      const body = document.getElementById("patients-body");
      if (!form || !body) return;

      // 3. Event Listeners de UI
      setupUIListeners(form);

      // 4. Carregamento Inicial
      loadPatients();
    }

    function setupUIListeners(form) {
      // Novo Paciente
      document.getElementById("new-btn")?.addEventListener("click", () => {
        document.getElementById("patient-id").value = "";
        form.reset();
        toggleForm(true);
      });

      // Cancelar
      document
        .getElementById("cancel-btn")
        ?.addEventListener("click", () => toggleForm(false));

      // Salvar (Submit)
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const id = document.getElementById("patient-id").value;
        const payload = {
          nome: document.getElementById("nome").value,
          email: document.getElementById("email").value,
          contato: document.getElementById("contato").value,
          valor_sessao:
            Number(document.getElementById("valor_sessao").value) || 0,
        };

        try {
          const url = id ? `${collectionBase}/${id}` : collectionBase;
          const res = await fetchWithAuth(url, {
            method: id ? "PUT" : "POST",
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error("Erro ao salvar");

          toggleForm(false);
          loadPatients();
        } catch (err) {
          console.error(err);
          alert("Erro ao salvar paciente.");
        }
      });
    }

    async function loadPatients() {
      const body = document.getElementById("patients-body");
      try {
        const res = await fetchWithAuth(collectionBase);
        const data = await res.json();
        render(data?.items || []);
      } catch (err) {
        console.error(err);
        if (body)
          body.innerHTML =
            '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
      }
    }

    function render(items) {
      const body = document.getElementById("patients-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nenhum paciente cadastrado.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (it) => `
      <tr class="border-t dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
        <td class="p-2 dark:text-gray-300">${it.nome || ""}</td>
        <td class="p-2 dark:text-gray-300">${it.email || ""}</td>
        <td class="p-2 dark:text-gray-300">${it.contato || ""}</td>
        <td class="p-2 dark:text-gray-300">R$ ${Number(it.valor_sessao).toFixed(2)}</td>
        <td class="p-2">
          <button data-id="${it.id}" class="edit-btn px-2 py-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900 rounded mr-2 transition">Editar</button>
          <button data-id="${it.id}" class="del-btn px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded transition">Excluir</button>
        </td>
      </tr>
    `,
        )
        .join("");

      attachRowListeners(items);
    }

    function attachRowListeners(items) {
      // Editar
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const record = items.find((i) => i.id === id);
          if (!record) return;

          document.getElementById("patient-id").value = record.id;
          document.getElementById("nome").value = record.nome || "";
          document.getElementById("email").value = record.email || "";
          document.getElementById("contato").value = record.contato || "";
          document.getElementById("valor_sessao").value =
            record.valor_sessao || "";

          toggleForm(true);
        });
      });

      // Excluir
      document.querySelectorAll(".del-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("Deseja realmente excluir este paciente?")) return;

          try {
            const res = await fetchWithAuth(`${collectionBase}/${id}`, {
              method: "DELETE",
            });
            if (res.ok) loadPatients();
          } catch (err) {
            alert("Erro ao excluir paciente.");
          }
        });
      });
    }

    function toggleForm(show) {
      document
        .getElementById("form-container")
        ?.classList.toggle("hidden", !show);
    }

    // --- CICLO DE VIDA ASTRO ---
    document.addEventListener("astro:page-load", init);

    // Fallback para carregamento direto
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
