---
import PageLayout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'Pacientes',
  description: 'Cadastro e gerenciamento de pacientes',
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-4xl py-12">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Pacientes</h1>
      <button id="new-btn" class="px-4 py-2 bg-blue-600 text-white rounded">Novo paciente</button>
    </div>

    <div id="form-container" class="mb-6 hidden bg-white dark:bg-gray-900 p-6 rounded shadow">
      <form id="patient-form" class="space-y-4">
        <input type="hidden" id="patient-id" />
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300">Nome</label>
          <input id="nome" class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 dark:text-gray-300">Email</label>
          <input id="email" class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800" />
        </div>
        <div class="flex space-x-2">
          <div class="flex-1">
            <label class="block text-sm text-gray-700 dark:text-gray-300">Contato</label>
            <input id="contato" class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800" />
          </div>
          <div class="w-40">
            <label class="block text-sm text-gray-700 dark:text-gray-300">Valor sessão</label>
            <input id="valor_sessao" type="number" class="mt-1 w-full rounded border p-2 bg-white dark:bg-gray-800" />
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
          <button id="cancel-btn" type="button" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded">Cancelar</button>
        </div>
      </form>
    </div>

    <div class="bg-white dark:bg-gray-900 rounded shadow p-4">
      <table class="w-full text-left table-auto">
        <thead>
          <tr class="text-sm text-gray-600 dark:text-gray-400">
            <th class="p-2">Nome</th>
            <th class="p-2">Email</th>
            <th class="p-2">Contato</th>
            <th class="p-2">Valor</th>
            <th class="p-2">Ações</th>
          </tr>
        </thead>
        <tbody id="patients-body" class="align-top">
          <tr><td colspan="5" class="p-4 text-center text-sm text-gray-500">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <script type="module">
    const collectionBase = '/api/pacientes';

    // init after DOM ready and ensure user authenticated
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const u = await fetch('/api/auth/user');
        const ud = await u.json();
        if (!ud.user) {
          window.location.href = '/login';
          return;
        }
      } catch (err) {
        console.error('auth check failed', err);
        window.location.href = '/login';
        return;
      }

      const newBtn = document.getElementById('new-btn');
      const formContainer = document.getElementById('form-container');
      const form = document.getElementById('patient-form');
      const cancelBtn = document.getElementById('cancel-btn');
      const body = document.getElementById('patients-body');

      function toggleForm(show = false) {
        if (!formContainer) return;
        formContainer.classList.toggle('hidden', !show);
      }

      if (newBtn) {
        newBtn.addEventListener('click', () => {
          const idField = document.getElementById('patient-id');
          if (idField) idField.value = '';
          if (form) form.reset();
          toggleForm(true);
        });
      }

      if (cancelBtn) cancelBtn.addEventListener('click', () => toggleForm(false));

      async function loadPatients() {
        try {
          const res = await fetch(collectionBase);
          const data = await res.json();
          if (data?.items) render(data.items);
          else render([]);
        } catch (err) {
          console.error(err);
          if (body) body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-sm text-red-500">Erro ao carregar</td></tr>';
        }
      }

      function render(items) {
        if (!body) return;
        if (!items || items.length === 0) {
          body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-sm text-gray-500">Nenhum paciente</td></tr>';
          return;
        }

        body.innerHTML = items
          .map((it) => `
            <tr class="border-t">
              <td class="p-2">${it.nome || ''}</td>
              <td class="p-2">${it.email || ''}</td>
              <td class="p-2">${it.contato || ''}</td>
              <td class="p-2">${it.valor_sessao ?? ''}</td>
              <td class="p-2">
                <button data-id="${it.id}" class="edit-btn px-2 py-1 bg-yellow-400 rounded mr-2">Editar</button>
                <button data-id="${it.id}" class="del-btn px-2 py-1 bg-red-500 text-white rounded">Excluir</button>
              </td>
            </tr>
          `)
          .join('');

        document.querySelectorAll('.edit-btn').forEach((b) =>
          b.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            const recRes = await fetch(`${collectionBase}/${id}`);
            const recData = await recRes.json();
            const record = recData.record;
            const idField = document.getElementById('patient-id');
            if (idField) idField.value = record.id;
            const nome = document.getElementById('nome');
            const email = document.getElementById('email');
            const contato = document.getElementById('contato');
            const valor = document.getElementById('valor_sessao');
            if (nome) nome.value = record?.nome || '';
            if (email) email.value = record?.email || '';
            if (contato) contato.value = record?.contato || '';
            if (valor) valor.value = record?.valor_sessao || '';
            toggleForm(true);
          })
        );

        document.querySelectorAll('.del-btn').forEach((b) =>
          b.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            if (!confirm('Excluir paciente?')) return;
            await fetch(`${collectionBase}/${id}`, { method: 'DELETE' });
            loadPatients();
          })
        );
      }

      if (form) {
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          const id = (document.getElementById('patient-id')).value;
          const payload = {
            nome: (document.getElementById('nome')).value,
            email: (document.getElementById('email')).value,
            contato: (document.getElementById('contato')).value,
            valor_sessao: Number((document.getElementById('valor_sessao')).value) || 0,
          };

          try {
            if (id) {
              await fetch(`${collectionBase}/${id}`, { method: 'PUT', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
            } else {
              await fetch(collectionBase, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
            }
            toggleForm(false);
            loadPatients();
          } catch (err) {
            console.error(err);
            alert('Erro ao salvar');
          }
        });
      }

      loadPatients();
    });
  </script>
</PageLayout>
