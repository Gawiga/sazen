---
import PageLayout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'Relatórios',
  description: 'Visualização de relatórios',
};
---

<PageLayout metadata={metadata}>
  <section class="mx-auto max-w-4xl py-12">
    <div class="mb-6">
      <a
        href="/dashboard"
        class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:underline mb-3"
        >← Voltar ao Dashboard</a
      >
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Relatórios</h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">Visualize faturamento e valores a receber</p>
    </div>
    <div class="space-y-8">
      <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6">
        <div class="mb-4">
          <div>
            <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Faturamento Mensal</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">Resumo mensal do faturamento</p>
          </div>
          <div
            class="mt-3 flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 items-start md:items-center bg-transparent md:bg-gray-50 dark:md:bg-gray-800 rounded-md p-0 md:p-2"
          >
            <input
              id="filter-fatur"
              placeholder="Filtrar por mês/ano"
              class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm w-full md:w-auto"
            />
            <select id="sort-fatur" class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm w-full md:w-auto">
              <option value="mes_ano">Ordenar por mês</option>
              <option value="total">Ordenar por total</option>
            </select>
            <div class="flex items-center space-x-2 w-full md:w-auto">
              <button id="order-fatur" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">Asc</button>
              <select id="page-size-fatur" class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
              </select>
              <button id="prev-fatur" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">◀</button>
              <span id="page-ind-fatur" class="text-sm text-gray-600 dark:text-gray-400">1</span>
              <button id="next-fatur" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">▶</button>
            </div>
          </div>
        </div>

        <div class="overflow-auto">
          <table id="table-fatur" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês/Ano</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              </tr>
            </thead>
            <tbody id="body-fatur" class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">
              <tr><td colspan="2" class="p-4 text-center text-sm text-gray-500">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6">
        <div class="mb-4">
          <div>
            <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Valores a Receber</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">Lista de valores pendentes por paciente</p>
          </div>
          <div
            class="mt-3 flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 items-start md:items-center bg-transparent md:bg-gray-50 dark:md:bg-gray-800 rounded-md p-0 md:p-2"
          >
            <input
              id="filter-rec"
              placeholder="Filtrar por nome"
              class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm w-full md:w-auto"
            />
            <select id="sort-rec" class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm w-full md:w-auto">
              <option value="nome">Ordenar por nome</option>
              <option value="total">Ordenar por total</option>
            </select>
            <div class="flex items-center space-x-2 w-full md:w-auto">
              <button id="order-rec" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">Asc</button>
              <select id="page-size-rec" class="px-2 py-2 rounded border bg-white dark:bg-gray-800 text-sm">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
              </select>
              <button id="prev-rec" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">◀</button>
              <span id="page-ind-rec" class="text-sm text-gray-600 dark:text-gray-400">1</span>
              <button id="next-rec" class="px-3 py-2 rounded border bg-white dark:bg-gray-800 text-sm">▶</button>
            </div>
          </div>
        </div>

        <div class="overflow-auto">
          <table id="table-rec" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              </tr>
            </thead>
            <tbody id="body-rec" class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">
              <tr><td colspan="2" class="p-4 text-center text-sm text-gray-500">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    const endpoint = '/api/reports';

    // Helper function to fetch with token
    function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem('pb_auth');
      const auth = token ? JSON.parse(token).token : null;
      const headers = { ...options.headers };
      if (auth) {
        headers.Authorization = `Bearer ${auth}`;
      }
      return fetch(url, { ...options, headers });
    }

    function tryParseNumber(v) {
      if (v == null) return 0;
      if (typeof v === 'number') return v;
      try {
        const parsed = JSON.parse(v);
        if (typeof parsed === 'number') return parsed;
        if (parsed && typeof parsed.total === 'number') return parsed.total;
      } catch {
        // not JSON
      }
      const n = Number(String(v).replace(/[^\d.-]+/g, ''));
      return Number.isNaN(n) ? 0 : n;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const u = await fetchWithAuth('/api/auth/user');
        const ud = await u.json();
        if (!ud.user) {
          window.location.href = '/login';
          return;
        }
      } catch (err) {
        console.error('auth check failed', err);
        window.location.href = '/login';
        return;
      }

      const bodyF = document.getElementById('body-fatur');
      const bodyR = document.getElementById('body-rec');
      const filterF = document.getElementById('filter-fatur');
      const sortF = document.getElementById('sort-fatur');
      const orderF = document.getElementById('order-fatur');
      const filterR = document.getElementById('filter-rec');
      const sortR = document.getElementById('sort-rec');
      const orderR = document.getElementById('order-rec');

      let fatur = [];
      let receber = [];

      // pagination state
      let pageF = 1;
      let pageSizeF = 10;
      let totalItemsF = 0;
      let pageR = 1;
      let pageSizeR = 10;
      let totalItemsR = 0;

      async function fetchCollectionPage(collection, page, perPage, q, sort, dir) {
        const params = new URLSearchParams({ collection, page: String(page), perPage: String(perPage) });
        if (q) params.set('q', q);
        if (sort) params.set('sort', sort);
        if (dir) params.set('dir', dir);
        const res = await fetchWithAuth(`${endpoint}?${params.toString()}`);
        return res.json();
      }

      async function loadF() {
        try {
          const q = filterF?.value || '';
          const dir = (orderF?.textContent || 'Asc').toLowerCase();
          const data = await fetchCollectionPage('faturamento_mensal', pageF, pageSizeF, q, sortF?.value, dir);
          // pb.getList returns { items, page, perPage, totalItems }
          const items = data.items || data.fatur || [];
          fatur = items;
          totalItemsF = data.totalItems || (Array.isArray(data.fatur) ? data.fatur.length : 0);
          renderF();
        } catch (err) {
          console.error('load reports fatur', err);
          if (bodyF)
            bodyF.innerHTML =
              '<tr><td colspan="2" class="p-4 text-center text-sm text-red-500">Erro ao carregar</td></tr>';
        }
      }

      async function loadR() {
        try {
          const q = filterR?.value || '';
          const dir = (orderR?.textContent || 'Asc').toLowerCase();
          const data = await fetchCollectionPage('valores_receber', pageR, pageSizeR, q, sortR?.value, dir);
          const items = data.items || data.receber || [];
          receber = items;
          totalItemsR = data.totalItems || (Array.isArray(data.receber) ? data.receber.length : 0);
          renderR();
        } catch (err) {
          console.error('load reports receber', err);
          if (bodyR)
            bodyR.innerHTML =
              '<tr><td colspan="2" class="p-4 text-center text-sm text-red-500">Erro ao carregar</td></tr>';
        }
      }

      const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

      function renderF() {
        if (!bodyF) return;
        if ((totalItemsF || 0) === 0) {
          bodyF.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-sm text-gray-500">Nenhum registro</td></tr>';
          document.getElementById('page-ind-fatur').textContent = `0 / 0`;
          return;
        }

        const totalPages = Math.max(1, Math.ceil((totalItemsF || 0) / pageSizeF));
        if (pageF > totalPages) pageF = totalPages;

        document.getElementById('page-ind-fatur').textContent = `${pageF} / ${totalPages}`;

        bodyF.innerHTML = (fatur || [])
          .map(
            (it) => `
          <tr class="border-t">
            <td class="p-2">${it.mes_ano ?? ''}</td>
            <td class="p-2">${currencyFormatter.format(tryParseNumber(it.total))}</td>
          </tr>
        `
          )
          .join('');
      }

      function renderR() {
        if (!bodyR) return;
        if ((totalItemsR || 0) === 0) {
          bodyR.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-sm text-gray-500">Nenhum registro</td></tr>';
          document.getElementById('page-ind-rec').textContent = `0 / 0`;
          return;
        }

        const totalPages = Math.max(1, Math.ceil((totalItemsR || 0) / pageSizeR));
        if (pageR > totalPages) pageR = totalPages;

        document.getElementById('page-ind-rec').textContent = `${pageR} / ${totalPages}`;

        bodyR.innerHTML = (receber || [])
          .map(
            (it) => `
          <tr class="border-t">
            <td class="p-2">${it.nome ?? ''}</td>
            <td class="p-2">${currencyFormatter.format(tryParseNumber(it.total))}</td>
          </tr>
        `
          )
          .join('');
      }

      const pageSizeFEl = document.getElementById('page-size-fatur');
      const prevF = document.getElementById('prev-fatur');
      const nextF = document.getElementById('next-fatur');
      const pageSizeREl = document.getElementById('page-size-rec');
      const prevR = document.getElementById('prev-rec');
      const nextR = document.getElementById('next-rec');

      [filterF, sortF, orderF].forEach((el) => {
        if (el)
          el.addEventListener('input', () => {
            pageF = 1;
            loadF();
          });
        if (el)
          el.addEventListener('change', () => {
            pageF = 1;
            loadF();
          });
      });
      [filterR, sortR, orderR].forEach((el) => {
        if (el)
          el.addEventListener('input', () => {
            pageR = 1;
            loadR();
          });
        if (el)
          el.addEventListener('change', () => {
            pageR = 1;
            loadR();
          });
      });

      if (orderF)
        orderF.addEventListener('click', () => {
          orderF.textContent = orderF.textContent === 'Asc' ? 'Desc' : 'Asc';
          loadF();
        });
      if (orderR)
        orderR.addEventListener('click', () => {
          orderR.textContent = orderR.textContent === 'Asc' ? 'Desc' : 'Asc';
          loadR();
        });

      if (pageSizeFEl)
        pageSizeFEl.addEventListener('change', () => {
          pageSizeF = Number(pageSizeFEl.value) || 10;
          pageF = 1;
          loadF();
        });
      if (pageSizeREl)
        pageSizeREl.addEventListener('change', () => {
          pageSizeR = Number(pageSizeREl.value) || 10;
          pageR = 1;
          loadR();
        });

      if (prevF)
        prevF.addEventListener('click', () => {
          if (pageF > 1) {
            pageF--;
            loadF();
          }
        });
      if (nextF)
        nextF.addEventListener('click', () => {
          pageF++;
          loadF();
        });
      if (prevR)
        prevR.addEventListener('click', () => {
          if (pageR > 1) {
            pageR--;
            loadR();
          }
        });
      if (nextR)
        nextR.addEventListener('click', () => {
          pageR++;
          loadR();
        });

      await Promise.all([loadF(), loadR()]);
    });
  </script>
</PageLayout>
