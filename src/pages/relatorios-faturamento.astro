---
import PageLayout from "~/layouts/PageLayout.astro";
import Loading from "~/components/widgets/Loading.astro";

const metadata = {
  title: "Relatórios - Faturamento Mensal",
  description: "Visualização do relatório de faturamento mensal",
};
---

<PageLayout metadata={metadata}>
  <Loading />
  <section class="mx-auto max-w-5xl px-4 py-8 sm:py-10">
    <div class="mb-6">
      <a
        href="/dashboard"
        class="mb-3 inline-flex min-h-11 items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        aria-label="Voltar ao Dashboard"
        >Voltar ao Dashboard</a
      >
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white sm:text-3xl">
        Faturamento Mensal
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Resumo mensal do faturamento.
      </p>
    </div>

    <div class="overflow-x-auto rounded border bg-white p-3 shadow dark:border-gray-800 dark:bg-gray-900 sm:p-4">
      <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Exibindo <span id="faturamento-count">0</span> registros
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Por página:</span>
          <button type="button" class="per-page-btn rounded border px-3 py-1 text-sm" data-per-page="20">20</button>
          <button type="button" class="per-page-btn rounded border px-3 py-1 text-sm" data-per-page="50">50</button>
          <button type="button" class="per-page-btn rounded border px-3 py-1 text-sm" data-per-page="100">100</button>
        </div>
      </div>

      <table class="w-full table-auto text-left">
        <thead>
          <tr class="border-b text-sm text-gray-600 dark:border-gray-700 dark:text-gray-400">
            <th class="p-2">Mês/Ano</th>
            <th class="p-2">Total</th>
          </tr>
        </thead>
        <tbody id="faturamento-body" class="align-top text-sm">
          <tr>
            <td colspan="2" class="p-4 text-center text-sm text-gray-500">Carregando...</td>
          </tr>
        </tbody>
      </table>

      <div class="mt-4 flex items-center justify-between gap-3">
        <button
          id="prev-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Anterior
        </button>
        <span id="page-indicator" class="text-sm text-gray-600 dark:text-gray-400">Página 1 de 1</span>
        <button
          id="next-page-btn"
          type="button"
          class="rounded border px-3 py-1 text-sm disabled:cursor-not-allowed disabled:opacity-50">
          Próxima
        </button>
      </div>
    </div>
  </section>

  <script>
    import { UIService } from "~/services/uiService";
    import { getPaginationView, getPerPageValue } from "~/services/paginationService";

    type ReportItem = {
      mes_ano?: string;
      total?: number | string;
    };

    const byId = (id: string): HTMLElement | null => document.getElementById(id);

    let currentPage = 1;
    let perPage = 20;
    let totalPages = 1;
    let totalItems = 0;
    const currencyFormatter = new Intl.NumberFormat("pt-BR", {
      style: "currency",
      currency: "BRL",
    });

    async function loadData(page = 1) {
      const body = byId("faturamento-body");
      try {
        const data = await UIService.get<{
          page: number;
          perPage: number;
          totalPages: number;
          totalItems: number;
          items: ReportItem[];
        }>(`/api/reports?collection=faturamento_mensal&page=${page}&perPage=${perPage}`);

        currentPage = data.page;
        totalPages = data.totalPages;
        totalItems = data.totalItems;

        render(data.items);
        updatePaginationControls();
        updateCount();
      } catch (err) {
        console.error(err);
        if (body) {
          body.innerHTML =
            '<tr><td colspan="2" class="p-4 text-center text-red-500">Erro ao carregar relatório.</td></tr>';
        }
      }
    }

    function render(items: ReportItem[]) {
      const body = byId("faturamento-body");
      if (!body) return;

      if (!items.length) {
        body.innerHTML =
          '<tr><td colspan="2" class="p-4 text-center text-gray-500">Nenhum registro encontrado.</td></tr>';
        return;
      }

      body.innerHTML = items
        .map(
          (item) => `
            <tr class="border-t transition hover:bg-gray-50 dark:border-gray-800 dark:hover:bg-gray-800">
              <td class="p-2 dark:text-gray-300">${item.mes_ano ?? "-"}</td>
              <td class="p-2 font-medium dark:text-white">${currencyFormatter.format(Number(item.total) || 0)}</td>
            </tr>
          `,
        )
        .join("");
    }

    function attachPerPageListeners() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          perPage = getPerPageValue(btn.getAttribute("data-per-page"), 20);
          currentPage = 1;
          updatePerPageButtons();
          loadData(currentPage);
        });
      });
    }

    function attachPaginationListeners() {
      byId("prev-page-btn")?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        loadData(currentPage - 1);
      });

      byId("next-page-btn")?.addEventListener("click", () => {
        if (currentPage >= totalPages) return;
        loadData(currentPage + 1);
      });
    }

    function updatePerPageButtons() {
      document.querySelectorAll(".per-page-btn").forEach((btn) => {
        const isActive = Number(btn.getAttribute("data-per-page")) === perPage;
        btn.classList.toggle("bg-blue-600", isActive);
        btn.classList.toggle("text-white", isActive);
        btn.classList.toggle("border-blue-600", isActive);
      });
    }

    function updatePaginationControls() {
      const prevBtn = byId("prev-page-btn") as HTMLButtonElement | null;
      const nextBtn = byId("next-page-btn") as HTMLButtonElement | null;
      const indicator = byId("page-indicator");

      const view = getPaginationView(currentPage, totalPages);
      if (prevBtn) prevBtn.disabled = !view.canPrev;
      if (nextBtn) nextBtn.disabled = !view.canNext;
      if (indicator) indicator.textContent = view.indicator;
    }

    function updateCount() {
      const countEl = byId("faturamento-count");
      if (countEl) countEl.textContent = String(totalItems);
    }

    function attachBannerListeners() {
      byId("close-faturamento-banner")?.addEventListener("click", () => {
        byId("faturamento-info-banner")?.classList.add("hidden");
      });
    }

    async function init() {
      const pbAuth = localStorage.getItem("pb_auth");
      if (!pbAuth) {
        window.location.href = "/login";
        return;
      }

      attachPerPageListeners();
      attachPaginationListeners();
      attachBannerListeners();
      updatePerPageButtons();
      updatePaginationControls();
      await loadData();
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", init);
    }
  </script>
</PageLayout>
